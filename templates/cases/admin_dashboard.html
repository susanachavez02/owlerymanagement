{% extends "base.html" %}

{% block content %}
<style>
  /* =========================
     CASE DASHBOARD (theme-aware)
     Aligns with your other pages using CSS vars from base.html
     ========================= */

  .dash-shell {
    border: 1px solid var(--border-color);
    border-radius: 16px;
    background: var(--bg-card);
    box-shadow: var(--shadow-sm, 0 10px 24px rgba(2,6,23,.10));
    overflow: hidden;
  }

  .dash-hero {
    padding: 20px 22px;
    background: linear-gradient(135deg, rgba(196,162,76,0.14), rgba(59,130,246,0.10));
    border-bottom: 1px solid var(--border-color);
  }
  :root[data-theme="dark"] .dash-hero{
    background: linear-gradient(135deg, rgba(196,162,76,0.14), rgba(59,130,246,0.14));
  }

  .dash-title {
    color: var(--text-main);
    font-weight: 800;
    margin: 0;
  }
  .dash-subtitle {
    color: var(--text-muted);
    margin: 4px 0 0 0;
  }

  .card-soft {
    background: var(--bg-card) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 16px !important;
    box-shadow: var(--shadow-sm, 0 8px 18px rgba(2,6,23,.08));
  }

  .stat-ico {
    width: 52px;
    height: 52px;
    border-radius: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-color);
    background: rgba(148,163,184,.10);
    flex-shrink: 0;
  }

  .stat-k {
    color: var(--text-muted);
    font-size: .75rem;
    letter-spacing: .06em;
    text-transform: uppercase;
    font-weight: 800;
  }
  .stat-v {
    color: var(--text-main);
    font-weight: 900;
    margin: 0;
    line-height: 1.1;
  }

  .section-title {
    color: var(--text-main);
    font-weight: 800;
    margin: 0;
  }
  .section-sub {
    color: var(--text-muted);
    margin: 6px 0 0 0;
    font-size: .92rem;
  }

  /* Table */
  .table-wrap {
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    background: var(--bg-card);
  }

  .table thead th {
    color: var(--text-muted) !important;
    font-weight: 800;
    font-size: .75rem;
    letter-spacing: .06em;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border-color) !important;
    padding-top: 14px;
    padding-bottom: 14px;
    background: rgba(148,163,184,.06) !important;
  }

  .table tbody td {
    color: var(--text-main) !important;
    border-color: var(--border-color) !important;
    padding: 14px 12px;
    vertical-align: middle;
  }

  .table-hover tbody tr:hover {
    background-color: rgba(148,163,184,.06) !important;
  }

  .case-link {
    color: var(--text-main) !important;
    font-weight: 800;
    text-decoration: none;
  }
  .case-link:hover {
    color: var(--primary) !important;
    text-decoration: underline;
  }

  /* Team avatars */
  .team-dot {
    width: 30px;
    height: 30px;
    border-radius: 999px;
    border: 1px solid var(--border-color);
    background: rgba(148,163,184,.10);
    color: var(--text-main);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: .72rem;
    box-shadow: var(--shadow-xs, 0 2px 6px rgba(2,6,23,.08));
  }

  /* Right rail buttons */
  .action-btn {
    background: rgba(148,163,184,.08);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    font-weight: 700;
    border-radius: 12px;
    padding: 10px 12px;
    text-align: left;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
    text-decoration: none;
    display: block;
  }
  .action-btn:hover {
    transform: translateY(-1px);
    background: rgba(148,163,184,.12);
    border-color: rgba(59,130,246,.35);
    color: var(--text-main);
  }

  /* Badges that work in both themes */
  .badge-soft {
    border: 1px solid var(--border-color);
    background: rgba(148,163,184,.12);
    color: var(--text-main);
    font-weight: 800;
    padding: 6px 10px;
    border-radius: 999px;
  }
  
  /* Status specific badges */
  .badge-scheduled {
      background: rgba(56, 189, 248, 0.12);
      color: #0ea5e9;
      border-color: rgba(56, 189, 248, 0.3);
  }
  .badge-needs-account {
      background: rgba(245, 158, 11, 0.12);
      color: #f59e0b;
      border-color: rgba(245, 158, 11, 0.3);
  }

  /* Fix bootstrap light/white clashes */
  .bg-light, .bg-white { background-color: transparent !important; }
  .text-secondary { color: var(--text-muted) !important; }
  
  /* Button overrides for dark mode contrast */
  .btn-outline-info { color: #0ea5e9; border-color: #0ea5e9; }
  .btn-outline-info:hover { background-color: #0ea5e9; color: white; }
  
  .btn-outline-success { color: #22c55e; border-color: #22c55e; }
  .btn-outline-success:hover { background-color: #22c55e; color: white; }
  
  .btn-outline-danger { color: #ef4444; border-color: #ef4444; }
  .btn-outline-danger:hover { background-color: #ef4444; color: white; }
</style>

<div class="container-fluid py-4">

  <div class="dash-shell mb-4">
    <div class="dash-hero d-flex flex-wrap align-items-center justify-content-between gap-3">
      <div>
        <h2 class="dash-title">Case Dashboard</h2>
        <p class="dash-subtitle">Overview of active matters, requests, and recent activity.</p>
      </div>
    </div>

    <div class="p-4 p-md-5">
      <div class="row g-4">

        <div class="col-lg-8">

          <div class="row g-3 mb-1">
            <div class="col-md-6">
              <div class="card card-soft h-100">
                <div class="card-body d-flex align-items-center gap-3 p-4">
                  <div class="stat-ico" style="color: var(--primary);">
                    <i class="fas fa-briefcase fa-lg"></i>
                  </div>
                  <div>
                    <div class="stat-k">Active Cases</div>
                    <h2 class="stat-v">{{ active_case_count }}</h2>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card card-soft h-100">
                <div class="card-body d-flex align-items-center gap-3 p-4">
                  <div class="stat-ico" style="color: #f59e0b;">
                    <i class="fas fa-file-signature fa-lg"></i>
                  </div>
                  <div>
                    <div class="stat-k">Pending Signatures</div>
                    <h2 class="stat-v">{{ pending_signature_count }}</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card card-soft mt-4">
            <div class="card-header" style="background: rgba(148,163,184,.06); border-bottom: 1px solid var(--border-color);">
              <div>
                <h6 class="section-title mb-0">Case Stages Overview</h6>
                <p class="section-sub mb-0">Distribution of cases by current stage.</p>
              </div>
            </div>
            <div class="card-body p-4">
              <canvas id="caseStageChart" style="max-height: 220px;"></canvas>
            </div>
          </div>

          <div class="card card-soft mt-4">
            <div class="card-header d-flex justify-content-between align-items-center"
                 style="background: rgba(148,163,184,.06); border-bottom: 1px solid var(--border-color);">
              <div>
                <h5 class="section-title mb-0">Active Cases List</h5>
                <p class="section-sub mb-0">Jump into any matter you are assigned to.</p>
              </div>
            </div>

            <div class="table-responsive table-wrap">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th class="ps-4">Case Title</th>
                    <th>Stage</th>
                    <th>Team</th>
                    <th>Filed</th>
                    <th class="text-end pe-4">Actions</th>
                  </tr>
                </thead>

                <tbody class="border-top-0">
                  {% for case in cases %}
                  <tr>
                    <td class="ps-4">
                      <a href="{% url 'cases:case-detail' case.pk %}" class="case-link">
                        {{ case.title }}
                      </a>
                    </td>

                    <td>
                      {% if case.current_stage %}
                        <span class="badge-soft" style="border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12);">
                          {{ case.current_stage.name }}
                        </span>
                      {% else %}
                        <span class="badge-soft">New</span>
                      {% endif %}
                    </td>

                    <td>
                      <div class="d-flex align-items-center">
                        {% for assignment in case.assignments.all %}
                          <div class="team-dot me-1"
                               title="{{ assignment.user.get_full_name }}">
                            {{ assignment.user.first_name|first|default:assignment.user.username|first|upper }}
                          </div>
                        {% endfor %}
                      </div>
                    </td>

                    <td class="small" style="color: var(--text-muted);">
                      {{ case.date_filed|date:"M d, Y" }}
                    </td>

                    <td class="text-end pe-4">
                      <a href="{% url 'cases:case-detail' case.pk %}"
                         class="btn btn-sm btn-primary">
                        View
                      </a>
                    </td>
                  </tr>

                  {% empty %}
                  <tr>
                    <td colspan="5" class="text-center py-5" style="color: var(--text-muted);">
                      <i class="far fa-folder-open fa-2x mb-2 opacity-50"></i>
                      <div class="fw-bold" style="color: var(--text-main);">No active cases found</div>
                      <div class="small">When cases are assigned, they will appear here.</div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <div class="col-lg-4">

          <div class="card card-soft mb-4">
            <div class="card-body p-4">
              <h6 class="stat-k mb-3">Quick Actions</h6>

              <div class="d-grid gap-2">
                <a href="{% url 'cases:case-create' %}" class="action-btn">
                  <i class="fas fa-plus me-2" style="color: var(--primary);"></i> Create New Case
                </a>

                <a href="#" class="action-btn">
                  <i class="far fa-calendar-plus me-2" style="color:#22c55e;"></i> Schedule Meeting
                </a>

                {% if is_admin_user %}
                <a href="#" class="action-btn">
                  <i class="fas fa-file-contract me-2" style="color: var(--text-muted);"></i> Manage Templates
                </a>

                <a href="{% url 'cases:user-management-list' %}" class="action-btn">
                  <i class="fas fa-users-cog me-2" style="color: var(--text-muted);"></i> Manage Users
                </a>

                <a href="#" class="action-btn">
                  <i class="fas fa-project-diagram me-2" style="color: var(--text-muted);"></i> Manage Workflows
                </a>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="card card-soft mb-4">
            <div class="card-header d-flex justify-content-between align-items-center"
                 style="background: rgba(239,68,68,.1); border-bottom: 1px solid var(--border-color);">
              <div class="fw-bold text-danger">
                <i class="fas fa-envelope-open-text me-2"></i> Requests
              </div>
              <span class="badge bg-danger rounded-pill">{{ consultations|length }}</span>
            </div>

            <div class="card-body p-0">
              <ul class="list-group list-group-flush">
                {% for req in consultations %}
                <li class="list-group-item border-0 p-3"
                    style="background: transparent; border-bottom: 1px solid var(--border-color) !important;">
                  
                  <div class="d-flex justify-content-between align-items-start mb-1">
                    <div class="fw-bold small" style="color: var(--text-main);">{{ req.name }}</div>
                    <small style="color: var(--text-muted);">{{ req.created_at|date:"M d" }}</small>
                  </div>

                  <p class="small mb-2" style="color: var(--text-muted);">
                    {{ req.service_needed|truncatewords:6 }}
                  </p>

                  {% if req.status == 'Scheduled' %}
                      <div class="badge-soft badge-scheduled mb-2 w-100 text-center">Meeting Scheduled</div>
                  {% elif req.status == 'Needs Account' %}
                      <div class="badge-soft badge-needs-account mb-2 w-100 text-center">Needs Account</div>
                  {% endif %}

                  {% if req.status == 'Pending' or req.status == 'Scheduled' %}
                      <div class="btn-group w-100 btn-group-sm" role="group">
                          <a href="{% url 'cases:schedule_consultation' req.pk %}" class="btn btn-outline-info">Schedule</a>
                          <a href="{% url 'cases:update_status' req.pk 'accepted' %}" class="btn btn-outline-success">Accept</a>
                          <a href="{% url 'cases:update_status' req.pk 'denied' %}" class="btn btn-outline-danger">Deny</a>
                      </div>
                  
                  {% elif req.status == 'Needs Account' and is_admin_user %}
                      <a href="{% url 'users:create_user' %}?email={{ req.email }}&first_name={{ req.name }}&consultation_id={{ req.id }}" 
                         class="btn btn-sm btn-warning w-100 fw-bold">
                         <i class="fas fa-user-plus me-1"></i> Create Account
                      </a>
                  {% endif %}

                </li>
                {% empty %}
                <li class="list-group-item text-center border-0 py-4" style="background: transparent;">
                  <small style="color: var(--text-muted);">No pending requests.</small>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>

          {% if is_admin_user %}
          <div class="card card-soft mb-4">
            <div class="card-header"
                 style="background: rgba(148,163,184,.06); border-bottom: 1px solid var(--border-color);">
              <small class="stat-k">Recent Activity</small>
            </div>

            <div class="card-body p-0">
              <ul class="list-group list-group-flush">
                {% for activity in recent_activity %}
                <li class="list-group-item border-0 px-3 py-2"
                    style="background: transparent; border-bottom: 1px solid var(--border-color) !important;">
                  <div class="d-flex align-items-start">
                    <div class="me-3 mt-1">
                      <i class="fas fa-history" style="color: var(--text-muted); font-size: .9rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="small" style="color: var(--text-main);">
                        <strong>{{ activity.case.title }}</strong> &rarr; {{ activity.stage.name }}
                      </div>
                      <div class="small" style="color: var(--text-muted); font-size: .75rem;">
                        {{ activity.timestamp_entered|timesince }} ago
                      </div>
                    </div>
                  </div>
                </li>

                {% empty %}
                <li class="list-group-item text-center border-0 py-3" style="background: transparent;">
                  <small style="color: var(--text-muted);">No recent activity.</small>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const canvas = document.getElementById('caseStageChart');
  if (!canvas) return;

  const labels = {{ stage_labels|safe }};
  const data = {{ stage_counts|safe }};

  const rootStyles = getComputedStyle(document.documentElement);
  const textMuted = rootStyles.getPropertyValue('--text-muted').trim() || '#64748b';
  const borderColor = rootStyles.getPropertyValue('--border-color').trim() || '#334155';

  new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Cases',
        data: data,
        backgroundColor: '#c4a24c',
        borderRadius: 6,
        barPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          titleColor: '#fff',
          bodyColor: '#fff'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1, color: textMuted },
          grid: {
            color: borderColor,
            borderDash: [3, 3],
            drawBorder: false
          }
        },
        x: {
          ticks: { color: textMuted },
          grid: { display: false }
        }
      }
    }
  });
});
</script>
{% endblock %}