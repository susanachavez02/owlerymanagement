{% extends "base.html" %}
{% load static %}

{% block title %}Calendar - Owlery Management{% endblock %}

{% block content %}
<style>
  /* =========================
     FULLCALENDAR THEME-AWARE STYLES
     Uses base.html CSS variables:
     --bg-body --bg-card --bg-input --text-main --text-muted --border-color --primary
     ========================= */

  .cal-shell{
    background-color: var(--bg-card);
    color: var(--text-main);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: var(--shadow-sm, 0 4px 10px rgba(2, 6, 23, 0.08));
    overflow: hidden;
  }

  .cal-toolbar{
    padding: 14px 16px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(148,163,184,0.06);
  }

  .cal-filters{
    padding: 14px 16px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(148,163,184,0.03);
  }

  .cal-filters .form-control,
  .cal-filters .form-select{
    background: var(--bg-input) !important;
    border-color: var(--border-color) !important;
    color: var(--text-main) !important;
  }
  .cal-filters .form-control::placeholder{ color: var(--text-muted) !important; opacity: .9; }
  .cal-filters label{ color: var(--text-muted); font-weight: 700; font-size: .75rem; text-transform: uppercase; letter-spacing: .03em; }

  .cal-legend{
    display:flex; flex-wrap:wrap; gap:10px;
    align-items:center;
    color: var(--text-muted);
    font-size: .85rem;
  }
  .legend-dot{
    width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px;border:1px solid var(--border-color);
  }

  #calendar {
    padding: 16px;
  }

  /* Toolbar Title */
  .fc .fc-toolbar-title {
    color: var(--text-main);
    font-weight: 800;
  }

  /* Header backgrounds + borders */
  .fc-theme-standard th,
  .fc-scrollgrid-section-header > *,
  .fc-col-header-cell {
    background-color: var(--bg-card) !important;
    border-color: var(--border-color) !important;
    color: var(--text-main) !important;
  }

  /* Header text (Sun/Mon/...) */
  .fc-col-header-cell-cushion {
    color: var(--text-main) !important;
    text-decoration: none !important;
    padding: 10px 0;
    font-weight: 700;
  }
  .fc-col-header-cell-cushion:hover {
    color: var(--primary) !important;
  }

  /* Grid borders */
  .fc-theme-standard td,
  .fc-theme-standard .fc-scrollgrid,
  .fc-scrollgrid-section > * {
    border-color: var(--border-color) !important;
  }

  /* Month view day numbers */
  .fc .fc-daygrid-day-number {
    color: var(--text-main) !important;
    text-decoration: none;
    padding: 8px;
  }

  /* Timegrid axis + labels */
  .fc-timegrid-axis-cushion,
  .fc-timegrid-axis {
    background-color: var(--bg-card) !important;
    color: var(--text-muted) !important;
    border-color: var(--border-color) !important;
  }
  .fc .fc-timegrid-slot-label-cushion { color: var(--text-muted) !important; }
  .fc .fc-timegrid-slot { border-bottom: 1px solid var(--border-color) !important; }

  /* "Today" highlight */
  :root[data-theme="light"] .fc .fc-day-today { background-color: rgba(59, 130, 246, 0.08) !important; }
  :root[data-theme="dark"] .fc .fc-day-today { background-color: rgba(59, 130, 246, 0.14) !important; }

  /* Buttons */
  .fc .fc-button-primary {
    background-color: var(--bg-input) !important;
    border-color: var(--border-color) !important;
    color: var(--text-main) !important;
    font-weight: 700;
    text-transform: capitalize;
    transition: all 0.15s ease;
  }
  .fc .fc-button-primary:hover {
    background-color: var(--primary) !important;
    border-color: var(--primary) !important;
    color: #ffffff !important;
    transform: translateY(-1px);
  }
  .fc .fc-button-primary:disabled {
    background-color: var(--bg-body) !important;
    border-color: var(--border-color) !important;
    opacity: 0.75;
  }
  .fc .fc-button-primary:not(:disabled).fc-button-active {
    background-color: var(--primary) !important;
    border-color: var(--primary) !important;
    color: #ffffff !important;
  }

  /* Events */
  .fc-event {
    cursor: pointer;
    border: none !important;
    padding: 2px 4px;
    font-size: 0.85rem;
    border-radius: 7px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.14);
  }

  /* Popover */
  .fc .fc-popover {
    background-color: var(--bg-card) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-main) !important;
  }
  .fc .fc-popover-header {
    background-color: var(--bg-card) !important;
    border-bottom: 1px solid var(--border-color) !important;
    color: var(--text-main) !important;
  }

  /* Links inside calendar */
  .fc a { color: var(--text-main); }

  /* Small helper text */
  .cal-help{
    color: var(--text-muted);
    font-size: .85rem;
  }

  /* Make bootstrap bg classes not fight theme */
  .bg-white, .bg-light { background-color: transparent !important; }
  .text-dark { color: var(--text-main) !important; }

/* ========== EVENT DETAILS MODAL ========== */
  .event-modal-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    animation: fadeIn 0.2s ease;
  }

  .event-modal-backdrop.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .event-modal {
    background-color: var(--bg-card);
    color: var(--text-main);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .event-modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .event-modal-title {
    font-size: 1.5rem;
    font-weight: 800;
    margin: 0;
    flex: 1;
    word-break: break-word;
  }

  .event-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s ease;
    margin-left: 16px;
    flex-shrink: 0;
  }

  .event-modal-close:hover {
    background-color: var(--bg-input);
    color: var(--text-main);
  }

  .event-modal-body {
    padding: 24px;
  }

  .event-detail-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 20px;
  }

  .event-detail-item:last-child {
    margin-bottom: 0;
  }

  .event-detail-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background-color: var(--bg-input);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    font-size: 1rem;
    flex-shrink: 0;
  }

  .event-detail-content {
    flex: 1;
    min-width: 0;
  }

  .event-detail-label {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--text-muted);
    margin-bottom: 4px;
  }

  .event-detail-value {
    font-size: 0.95rem;
    color: var(--text-main);
    word-break: break-word;
  }

  .event-type-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .event-type-badge.meeting { background-color: rgba(59, 130, 246, 0.15); color: #3b82f6; }
  .event-type-badge.consultation { background-color: rgba(245, 158, 11, 0.15); color: #f59e0b; }
  .event-type-badge.internal { background-color: rgba(34, 197, 94, 0.15); color: #22c55e; }
  .event-type-badge.hearing { background-color: rgba(239, 68, 68, 0.15); color: #ef4444; }
  .event-type-badge.deadline { background-color: rgba(239, 68, 68, 0.15); color: #ef4444; }

  .event-modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border-color);
    background-color: var(--bg-input);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  .event-modal-footer .btn {
    font-weight: 600;
    padding: 8px 16px;
    font-size: 0.9rem;
  }

  .event-modal-footer .btn-primary {
    background-color: var(--primary);
    color: white;
    border: none;
  }

  .event-modal-footer .btn-primary:hover {
    background-color: #2563eb;
  }

  .event-modal-footer .btn-secondary {
    background-color: transparent;
    color: var(--text-main);
    border: 1px solid var(--border-color);
  }

  .event-modal-footer .btn-secondary:hover {
    background-color: var(--bg-card);
    border-color: var(--primary);
    color: var(--primary);
  }

  .empty-state {
    text-align: center;
    padding: 20px;
    color: var(--text-muted);
  }
</style>

<section class="mb-5">
  <div class="container">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="page-title fw-bold mb-1">Calendar</h2>
        <div class="cal-help">Drag to reschedule, resize to change duration, or drag-select to create a meeting.</div>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'users:dashboard' %}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
        <a href="{% url 'cases:create-meeting' %}" class="btn btn-primary-action">
          <i class="fas fa-plus me-2"></i>Schedule Meeting
        </a>
      </div>
    </div>

    <div class="cal-shell">

      <div class="cal-toolbar d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="cal-legend">
          <span><span class="legend-dot" style="background:#3b82f6;border-color:#3b82f6;"></span>Meeting</span>
          <span><span class="legend-dot" style="background:#f59e0b;border-color:#f59e0b;"></span>Consultation</span>
          <span><span class="legend-dot" style="background:#22c55e;border-color:#22c55e;"></span>Internal</span>
          <span><span class="legend-dot" style="background:#ef4444;border-color:#ef4444;"></span>Hearing/Deadline</span>
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-outline-secondary btn-sm" id="btnToggleWeekends" type="button">
            <i class="fas fa-calendar-week me-2"></i><span id="weekendLabel">Hide Weekends</span>
          </button>
          <button class="btn btn-outline-secondary btn-sm" id="btnToday" type="button">
            <i class="fas fa-location-crosshairs me-2"></i>Today
          </button>
          <button class="btn btn-outline-secondary btn-sm" id="btnExportCsv" type="button">
            <i class="fas fa-file-csv me-2"></i>Export CSV
          </button>
          <button class="btn btn-outline-secondary btn-sm" id="btnSubscribe" type="button" title="Copy iCal subscription link">
            <i class="fas fa-rss me-2"></i>Subscribe (iCal)
          </button>
        </div>
      </div>

      <div class="cal-filters">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="calSearch" class="form-label mb-1">Search</label>
            <input id="calSearch" type="text" class="form-control" placeholder="Search title, case, location…">
          </div>

          <div class="col-md-3">
            <label for="calCase" class="form-label mb-1">Case</label>
            <select id="calCase" class="form-select">
              <option value="">All cases</option>
              {# Optional: if you pass cases to template, populate them #}
              {% if cases %}
                {% for c in cases %}
                  <option value="{{ c.pk }}">{{ c.case_title }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>

          <div class="col-md-3">
            <label for="calType" class="form-label mb-1">Type</label>
            <select id="calType" class="form-select">
              <option value="">All types</option>
              <option value="video">Video Conference</option>
              <option value="phone">Phone Call</option>
              <option value="in_person">In Person</option>
            </select>
          </div>

          <div class="col-md-2">
            <label for="calMine" class="form-label mb-1">Participants</label>
            <select id="calMine" class="form-select">
              <option value="">All</option>
              <option value="mine">Mine only</option>
            </select>
          </div>
        </div>
      </div>

      <div id="calendar"></div>
      <!-- EVENT DETAILS MODAL -->
      <div id="eventModal" class="event-modal-backdrop">
        <div class="event-modal">
          <div class="event-modal-header">
            <h2 class="event-modal-title" id="eventTitle">Event Title</h2>
            <button class="event-modal-close" onclick="closeEventModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="event-modal-body" id="eventModalBody">
            <!-- Populated by JavaScript -->
          </div>

          <div class="event-modal-footer">
            <button class="btn btn-secondary" onclick="closeEventModal()">Close</button>
            <button class="btn btn-primary" id="editEventBtn" onclick="editEvent()">
              <i class="fas fa-edit me-2"></i>Edit
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<script>
  let calendar;
  let currentEvent = null; // Store the currently selected event

  // You can wire this to a real ICS endpoint in Django.
  // Example server route you can implement later: /cases/api/calendar.ics/
  const ICAL_SUBSCRIBE_URL = '/cases/api/calendar.ics/';

  function getCssVar(name, fallback) {
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    return v || fallback;
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  function debounce(fn, delay) {
    let t;
    return function() {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, arguments), delay);
    };
  }

  function mapTypeToColor(type) {
    // Set colors consistent with the legend; you can adjust to match your brand palette.
    if (!type) return null;
    const t = String(type).toLowerCase();
    if (t.includes('consult')) return '#f59e0b';
    if (t.includes('internal')) return '#22c55e';
    if (t.includes('hearing') || t.includes('deadline')) return '#ef4444';
    return getCssVar('--primary', '#3b82f6'); // default
  }
  // ========== EVENT MODAL FUNCTIONS ==========
  function openEventModal(event) {
    currentEvent = event;
    const modal = document.getElementById('eventModal');
    const title = document.getElementById('eventTitle');
    const body = document.getElementById('eventModalBody');

    const props = event.extendedProps || {};
    const type = props.meetingType || props.type || 'Event';
    const caseTitle = props.case_title || props.case || '';
    const location = props.location || '';
    const owner = props.owner_name || props.owner || '';
    const description = props.description || '';
    const attendees = props.attendees || '';

    // Set title
    title.textContent = event.title;

    // Build the modal body HTML
    let bodyHTML = '';

    // Type badge
    const typeClass = type.toLowerCase().replace(/\s+/g, '-');
    bodyHTML += `
      <div class="event-detail-item">
        <div class="event-detail-icon">
          <i class="fas fa-tag"></i>
        </div>
        <div class="event-detail-content">
          <div class="event-detail-label">Type</div>
          <span class="event-type-badge ${typeClass}">${type}</span>
        </div>
      </div>
    `;

    // Date & Time
    if (event.start) {
      const startStr = event.start.toLocaleString();
      let timeHTML = `
        <div class="event-detail-item">
          <div class="event-detail-icon">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <div class="event-detail-content">
            <div class="event-detail-label">Date & Time</div>
            <div class="event-detail-value">${startStr}`;
      
      if (event.end) {
        timeHTML += ` to ${event.end.toLocaleString()}`;
      }
      timeHTML += `</div></div></div>`;
      bodyHTML += timeHTML;
    }

    // Case
    if (caseTitle) {
      bodyHTML += `
        <div class="event-detail-item">
          <div class="event-detail-icon">
            <i class="fas fa-briefcase"></i>
          </div>
          <div class="event-detail-content">
            <div class="event-detail-label">Case</div>
            <div class="event-detail-value">${caseTitle}</div>
          </div>
        </div>
      `;
    }

    // Location
    if (location) {
      bodyHTML += `
        <div class="event-detail-item">
          <div class="event-detail-icon">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div class="event-detail-content">
            <div class="event-detail-label">Location</div>
            <div class="event-detail-value">${location}</div>
          </div>
        </div>
      `;
    }

    // Organizer / Owner
    if (owner) {
      bodyHTML += `
        <div class="event-detail-item">
          <div class="event-detail-icon">
            <i class="fas fa-user"></i>
          </div>
          <div class="event-detail-content">
            <div class="event-detail-label">Organizer</div>
            <div class="event-detail-value">${owner}</div>
          </div>
        </div>
      `;
    }

    // Attendees
    if (attendees) {
      bodyHTML += `
        <div class="event-detail-item">
          <div class="event-detail-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="event-detail-content">
            <div class="event-detail-label">Attendees</div>
            <div class="event-detail-value">${attendees}</div>
          </div>
        </div>
      `;
    }

    // Description
    if (description) {
      bodyHTML += `
        <div class="event-detail-item">
          <div class="event-detail-icon">
            <i class="fas fa-sticky-note"></i>
          </div>
          <div class="event-detail-content">
            <div class="event-detail-label">Notes</div>
            <div class="event-detail-value">${description}</div>
          </div>
        </div>
      `;
    }

    if (!bodyHTML) {
      bodyHTML = '<div class="empty-state">No details available</div>';
    }

    body.innerHTML = bodyHTML;

    // Show modal with animation
    modal.classList.add('active');

    // Close modal when clicking outside of it
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeEventModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeEventModal();
      }
    });
  }

  function closeEventModal() {
    const modal = document.getElementById('eventModal');
    modal.classList.remove('active');
    currentEvent = null;
  }

  function editEvent() {
  if (!currentEvent) return;
  
  // Get the meeting ID from the event data (only declare once!)
  const meetingId = currentEvent.id;
  
  // Redirect to edit page
  window.location.href = `/cases/${meetingId}/edit-meeting/`;
}

  function buildCalendarOptions() {
    const primary = getCssVar('--primary', '#3b82f6');

    return {
      initialView: 'dayGridMonth',
      themeSystem: 'standard',

      headerToolbar: {
        left: 'prev,next',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
      },

      timeZone: 'local',
      nowIndicator: true,

      height: 'auto',
      dayMaxEvents: true,
      moreLinkClick: 'popover',

      weekends: true,

      businessHours: {
        daysOfWeek: [1,2,3,4,5],
        startTime: '08:00',
        endTime: '18:00'
      },
      slotMinTime: '07:00:00',
      slotMaxTime: '20:00:00',

      // Create by drag-select
      selectable: true,
      selectMirror: true,
      select: function(selectionInfo) {
        const start = selectionInfo.startStr;
        const end = selectionInfo.endStr;
        // Redirect to your existing schedule page with prefilled query params (server can read these)
        window.location.href = `{% url 'cases:create-meeting' %}?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;
      },

      // Drag/drop + resize to reschedule
      editable: true,
      eventStartEditable: true,
      eventDurationEditable: true,

      eventDrop: function(info) { updateEventTime(info.event, info); },
      eventResize: function(info) { updateEventTime(info.event, info); },

      // Fetch events with filters
      events: {
        url: '/cases/api/calendar-events/',
        extraParams: function() {
          return {
            q: document.getElementById('calSearch')?.value || '',
            case_id: document.getElementById('calCase')?.value || '',
            type: document.getElementById('calType')?.value || '',
            scope: document.getElementById('calMine')?.value || ''
          };
        }
      },

      // Default colors; can be overridden per-event by API or eventDidMount below
      eventColor: primary,
      eventTextColor: '#ffffff',

      // Click into event url (if API returns url)
      eventClick: function(info) {
        openEventModal(info.event);
        info.jsEvent.preventDefault();
      },

      // Tooltips + per-type coloring
      eventDidMount: function(info) {
        const props = info.event.extendedProps || {};
        const type = props.meeting_type || props.type || '';
        const caseTitle = props.case_title || props.case || '';
        const location = props.location || '';
        const owner = props.owner_name || props.owner || '';

        // Tooltip (simple, works everywhere)
        const lines = [
          info.event.title,
          type ? `Type: ${type}` : null,
          caseTitle ? `Case: ${caseTitle}` : null,
          location ? `Location: ${location}` : null,
          owner ? `With: ${owner}` : null
        ].filter(Boolean);
        info.el.setAttribute('title', lines.join('\n'));

        // Per-event coloring:
        // - If server already provides colors, keep them
        // - Otherwise color by type
        const hasServerColor = props.backgroundColor || props.color || info.event.backgroundColor;
        if (!hasServerColor) {
          const c = mapTypeToColor(type);
          if (c) {
            info.el.style.backgroundColor = c;
            info.el.style.borderColor = c;
            info.el.style.color = '#fff';
          }
        }
      }
    };
  }

  async function updateEventTime(event, infoObj) {
    const csrftoken = getCookie('csrftoken');
    const url = `/cases/api/calendar-events/${event.id}/`; // requires server support

    try {
      const res = await fetch(url, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
          start: event.start ? event.start.toISOString() : null,
          end: event.end ? event.end.toISOString() : null
        })
      });

      if (!res.ok) throw new Error('Update not supported');
    } catch (e) {
      // If your backend doesn’t support PATCH yet, revert so users aren’t misled.
      if (infoObj && typeof infoObj.revert === 'function') infoObj.revert();
      alert('Rescheduling is not enabled on the server yet (PATCH endpoint missing).');
    }
  }

  function exportVisibleEventsToCsv() {
    if (!calendar) return;

    const view = calendar.view;
    const start = view.activeStart;
    const end = view.activeEnd;

    // Events currently loaded in the client
    const events = calendar.getEvents().filter(ev => {
      const s = ev.start || new Date(0);
      return s >= start && s < end;
    });

    const header = ['Title','Start','End','Type','Case','Location','URL'];
    const rows = events.map(ev => {
      const p = ev.extendedProps || {};
      return [
        ev.title || '',
        ev.start ? ev.start.toISOString() : '',
        ev.end ? ev.end.toISOString() : '',
        (p.meeting_type || p.type || ''),
        (p.case_title || p.case || ''),
        (p.location || ''),
        (ev.url || '')
      ].map(v => `"${String(v).replaceAll('"','""')}"`).join(',');
    });

    const csv = [header.join(','), ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    const ts = new Date().toISOString().slice(0,10);
    link.href = url;
    link.download = `calendar_${ts}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  async function copyIcalSubscribeLink() {
    try {
      await navigator.clipboard.writeText(window.location.origin + ICAL_SUBSCRIBE_URL);
      alert('iCal subscription link copied to clipboard.');
    } catch (e) {
      // Fallback prompt if clipboard is blocked
      prompt('Copy this iCal subscription link:', window.location.origin + ICAL_SUBSCRIBE_URL);
    }
  }

  function wireFilters() {
    const refetch = debounce(() => { if (calendar) calendar.refetchEvents(); }, 250);

    ['calSearch','calCase','calType','calMine'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', refetch);
      el.addEventListener('change', refetch);
    });
  }

  function wireToolbarButtons() {
    const btnWeekends = document.getElementById('btnToggleWeekends');
    const label = document.getElementById('weekendLabel');

    if (btnWeekends) {
      btnWeekends.addEventListener('click', () => {
        const current = calendar.getOption('weekends');
        calendar.setOption('weekends', !current);
        if (label) label.textContent = current ? 'Show Weekends' : 'Hide Weekends';
      });
    }

    const btnToday = document.getElementById('btnToday');
    if (btnToday) btnToday.addEventListener('click', () => calendar.today());

    const btnExport = document.getElementById('btnExportCsv');
    if (btnExport) btnExport.addEventListener('click', exportVisibleEventsToCsv);

    const btnSub = document.getElementById('btnSubscribe');
    if (btnSub) btnSub.addEventListener('click', copyIcalSubscribeLink);
  }

  function attachThemeObserver() {
    const observer = new MutationObserver(function(mutations) {
      for (const m of mutations) {
        if (m.type === 'attributes' && m.attributeName === 'data-theme') {
          // Update options depending on CSS vars
          const opts = buildCalendarOptions();
          calendar.setOption('eventColor', opts.eventColor);
          calendar.setOption('eventTextColor', opts.eventTextColor);
          calendar.render();
        }
      }
    });
    observer.observe(document.documentElement, { attributes: true });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    calendar = new FullCalendar.Calendar(calendarEl, buildCalendarOptions());
    calendar.render();

    wireFilters();
    wireToolbarButtons();
    attachThemeObserver();
  });
</script>
{% endblock %}
