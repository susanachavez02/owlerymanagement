{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}

  {# --- 1. Header & Quick Links --- #}
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"> {# Added flex-wrap and gap #}
    <div>
      <a href="{% url 'users:dashboard' %}" class="btn btn-sm btn-outline-secondary mb-2">Back to Dashboard</a>
      <h2 class="mt-1 mb-0">{{ case.case_title }}</h2>
    </div>
    <div>
      <a href="{% url 'communication:case-messaging' case_pk=case.pk %}" class="btn btn-info">View Case Messages</a>
    </div>
  </div>
  <p class="lead">{{ case.description|default:"No description provided." }}</p>

  {# --- 2. Workflow Progress --- #}
  {% if all_stages %}
  <div class="mb-4">
    <h5>Case Progress:</h5>
    <ol class="list-group list-group-numbered mt-3">
      {% for stage in all_stages %}
        <li class="list-group-item d-flex justify-content-between align-items-start
                   {% if stage == case.current_stage %} active {% elif stage.order < case.current_stage.order %} list-group-item-success {% else %} list-group-item-light {% endif %}"> {# Added light for pending #}
          <div class="ms-2 me-auto">
            <div class="fw-bold">{{ stage.name }}</div>
            {% if stage == case.current_stage %}
              <small class="text-white-50">Current Stage</small> {# Adjusted text color for active item #}
            {% elif stage.order < case.current_stage.order %}
              <small class="text-success">Completed</small>
            {% else %}
              <small class="text-muted">Pending</small>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ol>

    {# Advance Stage Button - Only for Admin/Attorney & if not last stage #}
    {% if is_admin_user or 'Attorney' in user_roles %}
      {% if next_stage %} {# Check if a next_stage exists #}
        <form action="{% url 'cases:advance-stage' case_pk=case.pk %}" method="POST" class="mt-3">
          {% csrf_token %}
          <button type="submit" class="btn btn-success">
            Advance to Next Stage: {{ next_stage.name }} {# Use next_stage.name here #}
          </button>
        </form>
      {% elif case.current_stage %} {# Only show 'final stage' if there's a current stage #}
        <p class="text-success mt-3"><small>Case is in its final stage.</small></p>
      {% endif %}
    {% endif %}
  </div>
  <hr>
  {% endif %} {# End workflow section #}

  {# --- 3. Assigned Users --- #}
  <h5>Assigned Users</h5>
  <ul>
    {% for assignment in assignments %}
      <li>
  <a href="{% url 'profile-view' user_pk=assignment.user.pk %}">
    {{ assignment.user.get_full_name|default:assignment.user.username }}
  </a>
  ({{ assignment.user.roles.all|join:", " }})
</li>
    {% empty %}
      <li class="text-muted">No users are assigned to this case.</li>
    {% endfor %}
  </ul>
  <hr>

  {# --- 4a. Meetings Section --- #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5>Case Meetings</h5>
    {# Only admins can schedule meetings #}
    {% if is_admin_user %}
      <a href="{% url 'cases:create-meeting' case_pk=case.pk %}" class="btn btn-success">
        + Schedule Meeting
      </a>
    {% endif %}
  </div>
  <hr>

{# --- 4. Document Management Header  --- #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5>Case Documents</h5>
    <div class="d-flex align-items-center gap-2">
      {# Existing Generate Document link #}
      {% if is_admin_user or 'Attorney' in user_roles %}
      <a href="{% url 'cases:generate-document' case_pk=case.pk %}" class="btn btn-success">
        Generate Document
      </a>

      <div class="input-group">
        <select id="templateDropdown" class="form-control" style="max-width: 250px;">
          <option value="" disabled selected>Select Contract Template...</option>
          </select>
        
        <div class="input-group-append">
          <button id="templateDownloadBtn" class="btn btn-primary" disabled>
            <i class="fas fa-download"></i> Download PDF
          </button>
        </div>
      </div>
      
      {% endif %}
    </div>
  </div>

  

  {# --- 5. Document Upload Form --- #}
  <h6>Upload a New Document</h6>
  <form method="POST" enctype="multipart/form-data" novalidate class="mb-4">
    {% csrf_token %}
    {{ upload_form|crispy }}
    <button type="submit" name="upload_document" class="btn btn-primary mt-2">Upload</button>
  {# ...omitted code for upload form... #}
  </form>

  <h3 class="mt-4">Send Email Notification</h3>

  <form action="{% url 'communication:send_case_notification' case_id=case.id %}" method="POST" class="mb-4">
      
      {% csrf_token %}
      <div class="form-group">
          <label for="recipient_email">Recipient Email:</label>
          <input type="email" id="recipient_email" name="recipient_email" class="form-control" required>
      </div>
      <div class="form-group">
          <label for="subject">Subject:</label>
          <input type="text" id="subject" name="subject" class="form-control" required>
      </div>
      <div class="form-group">
          <label for="message">Message:</label>
          <textarea id="message" name="message" class="form-control" rows="5" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Send Notification</button>
  </form>

  <hr class="my-4">


  {# --- 7. Document List --- #}
  <h5>Existing Documents</h5>

  <div class="list-group mb-5">
    {% for doc in documents %}
      {# Use div for layout, allowing button placement #}
      <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2"> {# Added flex-wrap and gap #}
        <div>
          <a href="{% url 'cases:document-view' doc_pk=doc.pk %}" target="_blank" class="fw-bold">
            {{ doc.title }}
          </a>
          <small class="text-muted d-block">
            Uploaded by: 
            <a href="{% url 'profile-view' user_pk=doc.uploaded_by.pk %}">
              {{ doc.uploaded_by.username }}
            </a> 
            | Version: {{ doc.version_number }} | Viewed: {{ doc.logs.count }}
          </small>
        </div>
        {# Button Group for Actions #}
        <div>
          {# Show Request Signature only to relevant roles #}
          {% if is_admin_user or 'Attorney' in user_roles %}
            <a href="{% url 'cases:signature-request' doc_pk=doc.pk %}" class="btn btn-warning btn-sm">
              Request Signature
            </a>
          {% endif %}
          {# Add other document actions here later if needed (e.g., Delete) #}
        </div>
      </div>
    {% empty %}
      <div class="alert alert-info mt-3">No documents have been uploaded for this case.</div>
    {% endfor %}
  </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Use the actual primary key of the current case from Django context
        const caseId = {{ case.pk }}; 
        const templateDropdown = document.getElementById('templateDropdown');
        const downloadButton = document.getElementById('templateDownloadBtn');
        
        // --- 1. Fetch Templates and Populate Dropdown ---
        function fetchAndPopulateTemplates() {
            // Note: Assuming your API is mounted at /cases/api/
            fetch('/cases/api/templates/') 
                .then(response => response.json())
                .then(templates => {
                    templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id; // The template ID for the API
                        option.textContent = template.name; // The template name for display
                        templateDropdown.appendChild(option);
                    });
                    
                    // Enable the dropdown after options are loaded
                    templateDropdown.disabled = false;
                })
                .catch(error => {
                    console.error('Error fetching templates:', error);
                    templateDropdown.innerHTML = '<option value="" disabled selected>Error loading templates</option>';
                    templateDropdown.disabled = true;
                });
        }
        
        // --- 2. Handle Dropdown Selection and Enable Button ---
        templateDropdown.addEventListener('change', function() {
            const selectedTemplateId = this.value;
            // Enable the button only if a valid template is selected
            if (selectedTemplateId) {
                downloadButton.disabled = false;
            } else {
                downloadButton.disabled = true;
            }
        });

        // --- 3. Handle Download Click ---
        downloadButton.addEventListener('click', function() {
            const templateId = templateDropdown.value;
            if (templateId && caseId) {
                // Construct the dynamic URL: /api/templates/{template_pk}/download/{case_pk}/
                window.location.href = `/cases/api/templates/${templateId}/download/${caseId}/`;
            } else {
                alert('Please select a contract template first.');
            }
        });

        // Initial fetch
        fetchAndPopulateTemplates();
    });
  </script>
  	{% endblock %}