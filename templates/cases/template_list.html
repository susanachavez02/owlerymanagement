{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{% url 'cases:case-list' %}" class="btn btn-outline-secondary">&larr; Back</a>
    <h2 id="pageTitle">Contract Generator</h2>
    <div></div>
  </div>

  <p id="pageSubtitle" class="text-muted">
    Create custom bilingual contracts easily by filling in the details below.
  </p>

  <!-- Contract Form -->
  <div class="card shadow-sm mb-5">
    <div class="card-body">
      <h4 id="formTitle" class="card-title mb-3">Generate a New Contract</h4>
      <form id="contractForm">
        
        <!-- Language -->
        <div class="mb-3">
          <label for="language" class="form-label" id="languageLabel">Select Language</label>
          <select id="language" class="form-select" required>
            <option value="">Choose...</option>
            <option value="english">English</option>
            <option value="spanish">Español</option>
          </select>
        </div>

        <!-- Jurisdiction Section -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="region" class="form-label" id="regionLabel">Select Region</label>
            <select id="region" class="form-select" required>
              <option value="">Choose...</option>
              <option value="texas">Texas</option>
              <option value="mexico">Mexico</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="court" class="form-label" id="courtLabel">Select Court Type</label>
            <select id="court" class="form-select" required>
              <option value="">Choose...</option>
              <option value="local">Local</option>
              <option value="county">County</option>
              <option value="state">State</option>
              <option value="federal">Federal</option>
              <option value="supreme">Supreme Court</option>
            </select>
          </div>
        </div>

        <!-- Contract Selection -->
        <div class="mb-3">
          <label for="contract" class="form-label" id="contractLabel">Select Contract</label>
          <select id="contract" class="form-select" required>
            <option value="">Choose...</option>
            {% for pair in contract_choices %}
              <option value="{{ pair.0 }}">{{ pair.1 }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Inline Preview -->
        <div id="inlinePreview" class="card my-3" style="display:none;">
          <div class="card-body">
            <h5 class="card-title">Selected Contract Preview</h5>
            <!-- Use a CSS class so HTML renders normally (not forced pre-wrap) -->
            <div id="inlinePreviewContent" class="template-preview"></div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="text-center mt-4">
          <button type="button" id="previewBtn" class="btn btn-primary me-2">Preview Contract</button>
          <button type="button" id="downloadPDFBtn" class="btn btn-success">Download as PDF</button>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">Contract Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="previewContent" style="white-space: pre-wrap;"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeBtn">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  /* Inline contract preview styling to improve spacing and scrolling.
     Aim: keep content reasonably compact but visually clear and professional. */
  #inlinePreview .card-body {
    max-height: 52vh; /* slightly taller */
    overflow: auto;
    padding: 1rem 1.25rem;
    background: #ffffff;
  }

  /* Shared preview typography */
  .template-preview {
    white-space: normal;
    line-height: 1.7;
    font-size: 0.98rem;
    color: #222;
    font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    word-break: break-word;
  }

  .template-preview > * { margin-top: 0; }
  .template-preview p { margin: 0 0 1rem 0; }
  .template-preview h1, .template-preview h2, .template-preview h3 {
    margin: 1.25rem 0 0.5rem 0;
    line-height: 1.25;
  }
  .template-preview ul, .template-preview ol { margin: 0 0 0.9rem 1.25rem; }
  .template-preview img { max-width: 100%; height: auto; display: block; margin: 0.5rem 0; }

  /* Subtle card polish */
  #inlinePreview { border-radius: 0.35rem; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
  .template-preview code, .template-preview pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace; }

  /* Modal preview should mimic inline spacing but allow more vertical room */
  .modal-preview { white-space: normal !important; line-height: 1.7; font-size: 1rem; }
  .modal-body.modal-preview { max-height: 75vh; overflow: auto; }
</style>
<script>
const { jsPDF } = window.jspdf;

// Elements
const languageSelect = document.getElementById('language');
const regionSelect = document.getElementById('region');
const courtSelect = document.getElementById('court');
const contractSelect = document.getElementById('contract');
const previewBtn = document.getElementById('previewBtn');
const downloadPDFBtn = document.getElementById('downloadPDFBtn');
const previewContent = document.getElementById('previewContent');
let selectedContractHTML = "";
let currentlyLoadedFile = "";

// Translations
const translations = {
  english: {
    pageTitle: "Contract Generator",
    pageSubtitle: "Create custom bilingual contracts easily by filling in the details below.",
    formTitle: "Generate a New Contract",
    languageLabel: "Select Language",
    regionLabel: "Select Region",
    courtLabel: "Select Court Type",
    contractLabel: "Select Contract",
    choose: "Choose...",
    regions: { texas: "Texas", mexico: "Mexico" },
    courts: { local: "Local", county: "County", state: "State", federal: "Federal", supreme: "Supreme Court" },
    contracts: {},
    preview: "Preview Contract",
    download: "Download as PDF",
    close: "Close",
    modalTitle: "Contract Preview"
  },
  spanish: {
    pageTitle: "Generador de Contratos",
    pageSubtitle: "Cree contratos bilingües personalizados llenando los detalles a continuación.",
    formTitle: "Generar un Nuevo Contrato",
    languageLabel: "Seleccionar Idioma",
    regionLabel: "Seleccionar Región",
    courtLabel: "Seleccionar Tipo de Corte",
    contractLabel: "Seleccionar Contrato",
    choose: "Elegir...",
    regions: { texas: "Texas", mexico: "México" },
    courts: { local: "Local", county: "Condado", state: "Estatal", federal: "Federal", supreme: "Corte Suprema" },
    contracts: {},
    preview: "Vista Previa del Contrato",
    download: "Descargar como PDF",
    close: "Cerrar",
    modalTitle: "Vista Previa del Contrato"
  }
};

// Build contract labels dynamically
const contractFiles = JSON.parse('{{ contract_files_json|escapejs }}') || [];
const contractFetchUrl = "{% url 'cases:contract-template' %}";

function prettyLabel(name) {
  if (!name) return '';
  let s = String(name);

  // strip known filename suffixes
  s = s.replace(/_contract\.html$/i, '')
       .replace(/_contract$/i, '')
       .replace(/\.html$/i, '');

  // normalize separators
  s = s.replace(/[_\-]+/g, ' ');

  // break camelCase / PascalCase boundaries (lower->Upper)
  s = s.replace(/([a-z0-9])([A-Z])/g, '$1 $2');

  // split runs like "XMLParser" -> "XML Parser"
  s = s.replace(/([A-Z]+)([A-Z][a-z0-9]+)/g, '$1 $2');

  // Normalize common verbs: prefer "sell" over "sale"
  s = s.replace(/\bsale\b/gi, 'sell');

  // Specifically fix glued purchase+and+sell/sale variants (covers PurchaseandSell, purchaseandSale, purchaseandsell)
  s = s.replace(/purchase\s*and\s*(sell|sale)/gi, 'purchase and sell');
  s = s.replace(/purchaseand(sell|sale)/gi, 'purchase and sell');

  // collapse whitespace and trim
  s = s.replace(/\s+/g, ' ').trim();

  // Title case each word (keeps "And" capitalized per request)
  s = s.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());

  return s;
}

// Normalize any server-rendered <option> labels so every option shows the prettified name.
// Prefer option.value (filename) but fall back to option.textContent if needed.
function normalizeExistingContractOptions() {
  if (!contractSelect || !contractSelect.options) return;
  for (let i = 0; i < contractSelect.options.length; i++) {
    const opt = contractSelect.options[i];
    if (!opt.value) continue; // keep placeholder alone
    // use canonical filename (value) first
    const source = (opt.value || opt.textContent || '').trim();
    const pretty = prettyLabel(source);
    if (pretty && opt.textContent.trim() !== pretty) {
      opt.textContent = pretty;
    }
  }
}

// Ensure server-rendered options are normalized on initial load
document.addEventListener('DOMContentLoaded', () => {
  normalizeExistingContractOptions();
  // prefer explicit language, fall back to region, then English
  const defaultLang = languageSelect.value || (regionSelect.value === 'mexico' ? 'spanish' : 'english') || 'english';
  updateLanguage(defaultLang);
  languageSelect.value = defaultLang;
});

translations.english.contracts = {};
translations.spanish.contracts = {};
contractFiles.forEach(f => {
  translations.english.contracts[f] = prettyLabel(f);
  translations.spanish.contracts[f] = prettyLabel(f);
});

// ✅ Updated function that keeps selections
function updateLanguage(forceLang = null) {
  const lang = forceLang || languageSelect.value;
  if (!lang) return;
  const t = translations[lang];

  // Save current selections
  const prevRegion = regionSelect.value;
  const prevCourt = courtSelect.value;
  const prevContract = contractSelect.value;

  // Update text
  document.getElementById('pageTitle').textContent = t.pageTitle;
  document.getElementById('pageSubtitle').textContent = t.pageSubtitle;
  document.getElementById('formTitle').textContent = t.formTitle;
  document.getElementById('languageLabel').textContent = t.languageLabel;
  document.getElementById('regionLabel').textContent = t.regionLabel;
  document.getElementById('courtLabel').textContent = t.courtLabel;
  document.getElementById('contractLabel').textContent = t.contractLabel;
  document.getElementById('previewBtn').textContent = t.preview;
  document.getElementById('downloadPDFBtn').textContent = t.download;
  document.getElementById('closeBtn').textContent = t.close;
  document.getElementById('previewModalLabel').textContent = t.modalTitle;

  // Rebuild dropdowns
  regionSelect.innerHTML = `<option value="">${t.choose}</option>`;
  for (const [key, val] of Object.entries(t.regions)) {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = val;
    regionSelect.appendChild(opt);
  }

  courtSelect.innerHTML = `<option value="">${t.choose}</option>`;
  for (const [key, val] of Object.entries(t.courts)) {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = val;
    courtSelect.appendChild(opt);
  }

  contractSelect.innerHTML = `<option value="">${t.choose}</option>`;
  for (const [file, label] of Object.entries(t.contracts)) {
    const opt = document.createElement("option");
    opt.value = file;
    opt.textContent = label;
    contractSelect.appendChild(opt);
  }

  // Restore selections
  if (prevRegion && regionSelect.querySelector(`option[value="${prevRegion}"]`)) {
    regionSelect.value = prevRegion;
  }
  if (prevCourt && courtSelect.querySelector(`option[value="${prevCourt}"]`)) {
    courtSelect.value = prevCourt;
  }
  if (prevContract && contractSelect.querySelector(`option[value="${prevContract}"]`)) {
    contractSelect.value = prevContract;
  }

  languageSelect.value = lang;
}

// Event listeners
languageSelect.addEventListener("change", () => updateLanguage());

regionSelect.addEventListener("change", () => {
  if (regionSelect.value === "mexico") {
    updateLanguage("spanish");
    languageSelect.value = "spanish";
  } else if (regionSelect.value === "texas") {
    updateLanguage("english");
    languageSelect.value = "english";
  }
});

// Fetch contract file
async function loadContractTemplate(fileName) {
  try {
    const response = await fetch(`${contractFetchUrl}?file=${encodeURIComponent(fileName)}`);
    if (!response.ok) throw new Error("File not found");
    return await response.text();
  } catch (err) {
    console.error(err);
    return "Error loading contract template. Ensure the template exists under templates/cases/ and the server endpoint is reachable.";
  }
}

// Preview
previewBtn.addEventListener("click", async () => {
  const lang = languageSelect.value;
  const contractFile = contractSelect.value;

  if (!lang || !contractFile) {
    alert(lang === "spanish" ? "Seleccione un idioma y un contrato." : "Please select a language and a contract.");
    return;
  }

  selectedContractHTML = await loadContractTemplate(contractFile);
  previewContent.innerHTML = selectedContractHTML;

  const modal = new bootstrap.Modal(document.getElementById("previewModal"));
  modal.show();
});

// Download PDF
downloadPDFBtn.addEventListener("click", () => {
  if (!selectedContractHTML) {
    alert(languageSelect.value === "spanish" ? "Primero genere una vista previa del contrato." : "Please preview the contract first.");
    return;
  }

  const doc = new jsPDF();
  const text = selectedContractHTML.replace(/<[^>]*>/g, '');
  const lines = doc.splitTextToSize(text, 180);
  doc.text(lines, 15, 20);
  doc.save('Generated_Contract.pdf');
});

// Inline preview update
const inlinePreview = document.getElementById('inlinePreview');
const inlinePreviewContent = document.getElementById('inlinePreviewContent');

contractSelect.addEventListener('change', async () => {
  const file = contractSelect.value;
  if (!file) {
    selectedContractHTML = "";
    currentlyLoadedFile = "";
    inlinePreview.style.display = 'none';
    inlinePreviewContent.innerHTML = '';
    return;
  }

  if (file !== currentlyLoadedFile) {
    selectedContractHTML = await loadContractTemplate(file);
    currentlyLoadedFile = file;
  }

  inlinePreviewContent.innerHTML = selectedContractHTML;
  inlinePreview.style.display = 'block';
});
</script>
{% endblock %}
