{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{% url 'cases:case-list' %}" class="btn btn-outline-secondary">&larr; Back</a>
    <h2 id="pageTitle">Contract Generator</h2>
    <div></div>
  </div>

  <p id="pageSubtitle" class="text-muted">
    Create custom bilingual contracts easily by filling in the details below.
  </p>

  <!-- Contract Form -->
  <div class="card shadow-sm mb-5">
    <div class="card-body">
      <h4 id="formTitle" class="card-title mb-3">Generate a New Contract</h4>
      <form id="contractForm">
        
        <!-- Language -->
        <div class="mb-3">
          <label for="language" class="form-label" id="languageLabel">Select Language</label>
          <select id="language" class="form-select" required>
            <option value="">Choose...</option>
            <option value="english">English</option>
            <option value="spanish">Español</option>
          </select>
        </div>

        <!-- Jurisdiction Section -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="region" class="form-label" id="regionLabel">Select Region</label>
            <select id="region" class="form-select" required>
              <option value="">Choose...</option>
              <option value="texas">Texas</option>
              <option value="mexico">Mexico</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="court" class="form-label" id="courtLabel">Select Court Type</label>
            <select id="court" class="form-select" required>
              <option value="">Choose...</option>
              <option value="local">Local</option>
              <option value="county">County</option>
              <option value="state">State</option>
              <option value="federal">Federal</option>
              <option value="supreme">Supreme Court</option>
            </select>
          </div>
        </div>

        <!-- Contract Selection -->
        <div class="mb-3">
          <label for="contract" class="form-label" id="contractLabel">Select Contract</label>
          <select id="contract" class="form-select" required>
            <option value="">Choose...</option>
            {% for pair in contract_choices %}
              <option value="{{ pair.0 }}">{{ pair.1 }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Inline Preview (shows when a contract is selected) -->
        <div id="inlinePreview" class="card my-3" style="display:none;">
          <div class="card-body">
            <h5 class="card-title">Selected Contract Preview</h5>
            <div id="inlinePreviewContent" style="white-space: pre-wrap;"></div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="text-center mt-4">
          <button type="button" id="previewBtn" class="btn btn-primary me-2">Preview Contract</button>
          <button type="button" id="downloadPDFBtn" class="btn btn-success">Download as PDF</button>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">Contract Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="previewContent" style="white-space: pre-wrap;"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeBtn">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;

// Elements
const languageSelect = document.getElementById('language');
const regionSelect = document.getElementById('region');
const courtSelect = document.getElementById('court');
const contractSelect = document.getElementById('contract');
const previewBtn = document.getElementById('previewBtn');
const downloadPDFBtn = document.getElementById('downloadPDFBtn');
const previewContent = document.getElementById('previewContent');
let selectedContractHTML = "";
let currentlyLoadedFile = "";

// Translations
const translations = {
  english: {
    pageTitle: "Contract Generator",
    pageSubtitle: "Create custom bilingual contracts easily by filling in the details below.",
    formTitle: "Generate a New Contract",
    languageLabel: "Select Language",
    regionLabel: "Select Region",
    courtLabel: "Select Court Type",
    contractLabel: "Select Contract",
    choose: "Choose...",
    regions: { texas: "Texas", mexico: "Mexico" },
    courts: { local: "Local", county: "County", state: "State", federal: "Federal", supreme: "Supreme Court" },
    contracts: {
      // dynamically populated below
    },
    preview: "Preview Contract",
    download: "Download as PDF",
    close: "Close",
    modalTitle: "Contract Preview"
  },
  spanish: {
    pageTitle: "Generador de Contratos",
    pageSubtitle: "Cree contratos bilingües personalizados llenando los detalles a continuación.",
    formTitle: "Generar un Nuevo Contrato",
    languageLabel: "Seleccionar Idioma",
    regionLabel: "Seleccionar Región",
    courtLabel: "Seleccionar Tipo de Corte",
    contractLabel: "Seleccionar Contrato",
    choose: "Elegir...",
    regions: { texas: "Texas", mexico: "México" },
    courts: { local: "Local", county: "Condado", state: "Estatal", federal: "Federal", supreme: "Corte Suprema" },
    contracts: {
      // dynamically populated below
    },
    preview: "Vista Previa del Contrato",
    download: "Descargar como PDF",
    close: "Cerrar",
    modalTitle: "Vista Previa del Contrato"
  }
};

// Build contract labels dynamically from server-provided list
const contractFiles = JSON.parse('{{ contract_files_json|escapejs }}') || [];
const contractFetchUrl = "{% url 'cases:contract-template' %}";

function prettyLabel(name) {
  return name.replace('_contract.html','').replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
}

translations.english.contracts = {};
translations.spanish.contracts = {};
contractFiles.forEach(f => {
  translations.english.contracts[f] = prettyLabel(f);
  translations.spanish.contracts[f] = prettyLabel(f);
});

// Update language function
function updateLanguage(forceLang = null) {
  const lang = forceLang || languageSelect.value;
  if (!lang) return;
  const t = translations[lang];

  document.getElementById('pageTitle').textContent = t.pageTitle;
  document.getElementById('pageSubtitle').textContent = t.pageSubtitle;
  document.getElementById('formTitle').textContent = t.formTitle;
  document.getElementById('languageLabel').textContent = t.languageLabel;
  document.getElementById('regionLabel').textContent = t.regionLabel;
  document.getElementById('courtLabel').textContent = t.courtLabel;
  document.getElementById('contractLabel').textContent = t.contractLabel;
  document.getElementById('previewBtn').textContent = t.preview;
  document.getElementById('downloadPDFBtn').textContent = t.download;
  document.getElementById('closeBtn').textContent = t.close;
  document.getElementById('previewModalLabel').textContent = t.modalTitle;

  // Rebuild dropdowns dynamically
  regionSelect.innerHTML = `<option value="">${t.choose}</option>`;
  for (const [key, val] of Object.entries(t.regions)) {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = val;
    regionSelect.appendChild(opt);
  }

  courtSelect.innerHTML = `<option value="">${t.choose}</option>`;
  for (const [key, val] of Object.entries(t.courts)) {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = val;
    courtSelect.appendChild(opt);
  }

  contractSelect.innerHTML = `<option value="">${t.choose}</option>`;
  for (const [file, label] of Object.entries(t.contracts)) {
    const opt = document.createElement("option");
    opt.value = file;
    opt.textContent = label;
    contractSelect.appendChild(opt);
  }

  // Keep selection after language change
  languageSelect.value = lang;
}

languageSelect.addEventListener("change", () => updateLanguage());
regionSelect.addEventListener("change", () => {
  if (regionSelect.value === "mexico") {
    updateLanguage("spanish");
    languageSelect.value = "spanish";
  } else if (regionSelect.value === "texas") {
    updateLanguage("english");
    languageSelect.value = "english";
  }
});

// Fetch Contract Template
async function loadContractTemplate(fileName) {
  try {
    const response = await fetch(`${contractFetchUrl}?file=${encodeURIComponent(fileName)}`);
    if (!response.ok) throw new Error("File not found");
    return await response.text();
  } catch (err) {
    console.error(err);
    return "Error loading contract template. Ensure the template exists under templates/cases/ and the server endpoint is reachable.";
  }
}

// Preview
previewBtn.addEventListener("click", async () => {
  const lang = languageSelect.value;
  const contractFile = contractSelect.value;

  if (!lang || !contractFile) {
    alert(lang === "spanish" ? "Seleccione un idioma y un contrato." : "Please select a language and a contract.");
    return;
  }

  selectedContractHTML = await loadContractTemplate(contractFile);
  previewContent.innerHTML = selectedContractHTML;

  const modal = new bootstrap.Modal(document.getElementById("previewModal"));
  modal.show();
});

// Download PDF
downloadPDFBtn.addEventListener("click", () => {
  if (!selectedContractHTML) {
    alert(languageSelect.value === "spanish" ? "Primero genere una vista previa del contrato." : "Please preview the contract first.");
    return;
  }

  const doc = new jsPDF();
  const text = selectedContractHTML.replace(/<[^>]*>/g, '');
  const lines = doc.splitTextToSize(text, 180);
  doc.text(lines, 15, 20);
  doc.save('Generated_Contract.pdf');
});

// Load selected contract into the inline preview when selection changes
const inlinePreview = document.getElementById('inlinePreview');
const inlinePreviewContent = document.getElementById('inlinePreviewContent');

contractSelect.addEventListener('change', async () => {
  const file = contractSelect.value;
  if (!file) {
    selectedContractHTML = "";
    currentlyLoadedFile = "";
    inlinePreview.style.display = 'none';
    inlinePreviewContent.innerHTML = '';
    return;
  }

  // If the currently loaded file differs, fetch it
  if (file !== currentlyLoadedFile) {
    selectedContractHTML = await loadContractTemplate(file);
    currentlyLoadedFile = file;
  }

  inlinePreviewContent.innerHTML = selectedContractHTML;
  inlinePreview.style.display = 'block';
});

// Make Preview button reuse already-fetched content when possible
previewBtn.addEventListener("click", async () => {
  const lang = languageSelect.value;
  const contractFile = contractSelect.value;

  if (!lang || !contractFile) {
    alert(lang === "spanish" ? "Seleccione un idioma y un contrato." : "Please select a language and a contract.");
    return;
  }

  if (!selectedContractHTML || currentlyLoadedFile !== contractFile) {
    selectedContractHTML = await loadContractTemplate(contractFile);
    currentlyLoadedFile = contractFile;
  }

  previewContent.innerHTML = selectedContractHTML;

  const modal = new bootstrap.Modal(document.getElementById("previewModal"));
  modal.show();
});
</script>
{% endblock %}
