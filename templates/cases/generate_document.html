{% extends "base.html" %}

{% block content %}
<div class="container-fluid bg-light min-vh-100 d-flex flex-column align-items-center py-4">
    
    <div class="w-100 max-w-4xl d-flex justify-content-between align-items-center mb-3 px-3">
        <div>
            <a href="{% url 'cases:case-detail' pk=case.pk %}" class="text-decoration-none text-secondary mb-1 d-block">
                &larr; Back to Case
            </a>
            <h4 class="m-0 text-dark">Generate: {{ case.case_title }}</h4>
        </div>
        
        <div class="d-flex gap-2">
            <select class="form-select w-auto" id="html_contract_select" style="min-width: 250px;">
                <option value="" selected disabled>Select a Template...</option>
                {% if db_templates %}
                <optgroup label="My Custom Templates">
                    {% for t in db_templates %}
                        <option value="db-{{ t.id }}">{{ t.name }}</option>
                    {% endfor %}
                </optgroup>
                {% endif %}
                <optgroup label="Standard Forms">
                    {% for choice in contract_choices %}
                        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                    {% endfor %}
                </optgroup>
            </select>

            <button id="download_pdf" class="btn btn-primary">
                <i class="fas fa-print me-2"></i> Download PDF
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-3 p-2 d-flex flex-row gap-3 align-items-center user-select-none" style="position: sticky; top: 10px; z-index: 1000;">
        
        <div class="d-flex align-items-center pe-3">
            <span class="text-muted fw-bold small text-uppercase me-2">Zoom:</span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" id="zoomOutBtn"><i class="fas fa-minus"></i></button>
                <span class="btn btn-outline-secondary disabled text-dark fw-bold" id="zoomLevelDisplay" style="width: 60px;">100%</span>
                <button class="btn btn-outline-secondary" id="zoomInBtn"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="vr mx-2"></div>
        <small class="text-muted ms-auto">
            <strong>Click</strong> highlighted boxes to fill.
        </small>
    </div>

    <div class="card shadow-sm border-0 overflow-auto" style="width: 100%; max-width: 100%;">
        <div class="card-body p-0 bg-white min-vh-100 d-flex flex-column align-items-center pt-5 pb-5" id="document_canvas" style="transform-origin: top center; transition: transform 0.1s ease-out;">
            <div id="placeholder_msg" class="text-center text-muted py-5 mt-5">
                <i class="fas fa-file-alt fa-3x mb-3 text-secondary opacity-50"></i>
                <h5>Select a template above to begin</h5>
            </div>
        </div>
    </div>
</div>

<style>
    /* --- DOCUMENT STYLES --- */
    body { overflow-y: scroll; }
    
    .pdf-page { 
        position: relative; 
        user-select: none; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        margin-bottom: 30px;
        z-index: 1; 
        line-height: 0; 
    }
    
    .pdf-page img { 
        pointer-events: none; 
        width: 100%; 
        height: 100%;
        display: block; 
    } 

    /* --- FIELD WRAPPER --- */
    .field-wrapper {
        position: absolute;
        border: 1px dashed rgba(0, 0, 0, 0.3);
        background: rgba(255, 255, 0, 0.1); 
        box-sizing: border-box;
        z-index: 10; 
        display: flex; 
        align-items: center; 
        justify-content: flex-start; 
        cursor: text;
    }
    
    /* --- SELECTED STATE --- */
    .field-wrapper.selected {
        border: 2px solid #0d6efd; 
        background: rgba(13, 110, 253, 0.05);
        z-index: 20; 
    }

    /* --- INPUT STYLES --- */
    .pdf-input {
        width: 100%; 
        height: 100%;
        background: transparent;
        border: none; 
        outline: none;
        font-family: 'Courier New', monospace;
        font-weight: bold; 
        font-size: 14px;
        padding: 4px; 
        margin: 0; 
        resize: none; 
        cursor: text; 
        user-select: auto; 
        box-sizing: border-box; 
    }
    
    /* --- CHECKBOX SPECIFIC --- */
    input[type="checkbox"].pdf-input {
        margin: 0;
        cursor: pointer;
        width: 100%; 
        height: 100%;
    }
</style>

<script>
    const contractTemplateUrl = "{% url 'cases:contract-template' %}";
    const selectEl = document.getElementById('html_contract_select');
    const canvas = document.getElementById('document_canvas');
    const downloadBtn = document.getElementById('download_pdf');
    
    // ZOOM VARIABLES
    let currentZoom = 1.0;
    const zoomStep = 0.1;
    const maxZoom = 2.0;
    const minZoom = 0.5;
    const zoomDisplay = document.getElementById('zoomLevelDisplay');

    let selectedField = null; 

    // --- 1. LOAD TEMPLATE ---
    async function fetchTemplate(fileName){
      if (fileName && fileName.startsWith('db-')) {
        const id = fileName.replace('db-', '');
        try {
          const response = await fetch(`/cases/api/templates/${id}/`);
          if (!response.ok) throw new Error("Failed");
          const data = await response.json();
          return data.content; 
        } catch (e) { 
            return "<div class='p-5 text-danger text-center'>Error loading template.</div>"; 
        }
      }
      const resp = await fetch(contractTemplateUrl + '?file=' + encodeURIComponent(fileName));
      return await resp.text();
    }

    selectEl.addEventListener('change', async (e) => {
        const file = e.target.value;
        if(!file) return;
        
        // Show loading spinner
        canvas.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
        
        // Reset Zoom
        currentZoom = 1.0;
        updateZoomUI();

        // Load Content
        const content = await fetchTemplate(file);
        canvas.innerHTML = content;

        // --- THE FIX: UNLOCK ALL FIELDS ---
        // The creator saves them as 'readonly' by default. We must remove that here.
        canvas.querySelectorAll('.pdf-input').forEach(input => {
            input.removeAttribute('readonly');
            // Also ensure checkboxes are clickable
            input.style.pointerEvents = 'auto'; 
        });
    });

    // --- 2. ZOOM LOGIC ---
    function updateZoomUI() {
        canvas.style.transform = `scale(${currentZoom})`;
        zoomDisplay.textContent = Math.round(currentZoom * 100) + '%';
    }

    document.getElementById('zoomInBtn').addEventListener('click', () => {
        if (currentZoom < maxZoom) { currentZoom += zoomStep; updateZoomUI(); }
    });

    document.getElementById('zoomOutBtn').addEventListener('click', () => {
        if (currentZoom > minZoom) { currentZoom -= zoomStep; updateZoomUI(); }
    });

    // --- 3. MOUSE HANDLING ---
    canvas.addEventListener('mousedown', function(e) {
        
        // CLICK FIELD -> SELECT & FOCUS
        const wrapper = e.target.closest('.field-wrapper');
        if (wrapper) {
            selectField(wrapper);
            const input = wrapper.querySelector('input');
            
            // Force focus to enable typing immediately
            if(input) {
                input.focus();
            }
            return;
        }

        // CLICK ELSEWHERE -> DESELECT
        if (selectedField) {
            deselectField();
        }
    });

    // --- 4. SELECTION HELPERS ---
    function selectField(wrapper) {
        if (selectedField && selectedField !== wrapper) {
            selectedField.classList.remove('selected');
        }
        selectedField = wrapper;
        wrapper.classList.add('selected');
    }

    function deselectField() {
        if (selectedField) {
            selectedField.classList.remove('selected');
            selectedField = null;
        }
    }

    // --- 5. DOWNLOAD (ACCURATE PRINT) ---
    downloadBtn.addEventListener('click', () => {
        if(!canvas.querySelector('.pdf-page')) return alert("Select template first.");
        
        deselectField();
        
        // Reset zoom for accurate cloning
        const oldZoom = currentZoom;
        canvas.style.transform = 'scale(1)'; 
        const printContent = canvas.cloneNode(true);
        canvas.style.transform = `scale(${oldZoom})`; 

        // Convert Inputs to Static Text for Print
        const wrappers = printContent.querySelectorAll('.field-wrapper');
        wrappers.forEach(w => {
            const liveWrapper = canvas.querySelectorAll('.field-wrapper')[Array.from(wrappers).indexOf(w)];
            const liveInput = liveWrapper.querySelector('input');
            
            const span = document.createElement('span');
            span.style.position = 'absolute';
            span.style.left = w.style.left;
            span.style.top = w.style.top;
            span.style.width = w.style.width;
            span.style.height = w.style.height;
            span.style.fontFamily = 'Courier New';
            span.style.fontWeight = 'bold';
            span.style.zIndex = '50';
            span.style.display = 'flex';
            span.style.alignItems = 'center'; 
            
            if (liveInput.type === 'checkbox') {
                span.textContent = liveInput.checked ? "X" : "";
                span.style.justifyContent = 'center';
                span.style.fontSize = '1.2em';
            } else {
                span.textContent = liveInput.value;
                span.style.fontSize = '12px'; 
                span.style.paddingLeft = '5px';
                span.style.whiteSpace = 'nowrap';
            }
            
            span.style.border = 'none';
            span.style.background = 'transparent';
            
            w.parentNode.replaceChild(span, w);
        });

        // Open Print Window
        const win = window.open('', '', 'height=900,width=800');
        win.document.write('<html><head><title>Print Document</title>');
        win.document.write(`
            <style>
                @page { margin: 0; size: auto; } 
                body { margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
                .pdf-page { 
                    position: relative; 
                    page-break-after: always; 
                    overflow: hidden;
                    margin: 0 auto; 
                }
                img { width: 100%; height: 100%; display: block; }
            </style>
        `);
        win.document.write('</head><body>');
        win.document.write(printContent.innerHTML);
        win.document.write('</body></html>');
        
        win.document.close();
        
        setTimeout(() => { 
            win.focus();
            win.print(); 
            win.close(); 
        }, 500);
    });
</script>
{% endblock %}