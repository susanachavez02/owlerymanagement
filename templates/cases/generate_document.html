{% extends "base.html" %}

{% block content %}
<style>
  /* =========================
     THEME-AWARE LAYOUT / POLISH
     ========================= */
  .gen-shell{
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
  }

  .gen-hero{
    background: linear-gradient(135deg, rgba(196,162,76,0.14), rgba(59,130,246,0.10));
    border-bottom: 1px solid var(--border-color);
  }
  :root[data-theme="dark"] .gen-hero{
    background: linear-gradient(135deg, rgba(196,162,76,0.14), rgba(59,130,246,0.14));
  }

  .toolbar-card{
    position: sticky;
    top: 10px;
    z-index: 1000;
    border: 1px solid var(--border-color);
    border-radius: 14px;
    background: var(--bg-card);
    box-shadow: var(--shadow-sm, 0 4px 10px rgba(2, 6, 23, 0.08));
  }

  .hint-chip{
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .35rem .6rem;
    border-radius: 999px;
    border: 1px solid var(--border-color);
    background-color: rgba(148,163,184,0.10);
    color: var(--text-muted);
    font-size: .85rem;
    font-weight: 600;
  }

  /* Make select look consistent in both themes */
  #html_contract_select{
    background-color: var(--bg-input) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-main) !important;
  }
  #html_contract_select:focus{
    border-color: var(--primary) !important;
    box-shadow: 0 0 0 .25rem rgba(59,130,246,0.18) !important;
  }

  /* Document canvas wrapper */
  .doc-frame{
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    background: var(--bg-card);
  }

  /* The inside “paper area” should stay light for readable forms */
  #document_canvas{
    background: #ffffff;
    color: #111827;
  }

  /* =========================
     DOCUMENT STYLES
     ========================= */
  body { overflow-y: scroll; }

  .pdf-page {
    position: relative;
    user-select: none;
    box-shadow: 0 10px 18px rgba(0,0,0,0.12);
    margin-bottom: 30px;
    z-index: 1;
    line-height: 0;
    border-radius: 10px;
    overflow: hidden;
    background: #fff;
  }

  .pdf-page img {
    pointer-events: none;
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Field wrapper */
  .field-wrapper{
    position: absolute;
    border: 1px dashed rgba(17, 24, 39, 0.35);
    background: rgba(250, 204, 21, 0.12);
    box-sizing: border-box;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    cursor: text;
    border-radius: 6px;
  }

  .field-wrapper:hover{
    background: rgba(250, 204, 21, 0.18);
  }

  /* Selected state */
  .field-wrapper.selected{
    border: 2px solid var(--primary);
    background: rgba(59, 130, 246, 0.08);
    z-index: 20;
  }

  /* Inputs */
  .pdf-input{
    width: 100%;
    height: 100%;
    background: transparent;
    border: none;
    outline: none;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-weight: 700;
    font-size: 14px;
    padding: 4px;
    margin: 0;
    resize: none;
    cursor: text;
    user-select: auto;
    box-sizing: border-box;
    color: #111827;
  }

  /* Checkbox specific */
  input[type="checkbox"].pdf-input{
    margin: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }
</style>

<div class="container-fluid py-4">
  <div class="gen-shell card shadow-sm border-0">

    <!-- HERO / HEADER -->
    <div class="gen-hero p-4 p-md-5">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
          <a href="{% url 'cases:case-detail' pk=case.pk %}" class="text-decoration-none d-inline-flex align-items-center gap-2">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Case</span>
          </a>
          <h4 class="fw-bold mb-1 mt-2">Generate Document</h4>
          <p class="text-muted mb-0">Case: <strong>{{ case.case_title }}</strong></p>
        </div>

        <div class="d-flex flex-wrap gap-2 align-items-center">
          <select class="form-select" id="html_contract_select" style="min-width: 260px;">
            <option value="" selected disabled>Select a Template...</option>

            {% if db_templates %}
            <optgroup label="My Custom Templates">
              {% for t in db_templates %}
                <option value="db-{{ t.id }}">{{ t.name }}</option>
              {% endfor %}
            </optgroup>
            {% endif %}

            <optgroup label="Standard Forms">
              {% for choice in contract_choices %}
                <option value="{{ choice.0 }}">{{ choice.1 }}</option>
              {% endfor %}
            </optgroup>
          </select>

          <button id="download_pdf" class="btn btn-primary-action">
            <i class="fas fa-print me-2"></i>Download PDF
          </button>
        </div>
      </div>
    </div>

    <div class="card-body p-3 p-md-4">

      <!-- STICKY TOOLBAR -->
      <div class="toolbar-card p-2 px-3 mb-3 d-flex flex-row gap-3 align-items-center user-select-none">
        <div class="d-flex align-items-center pe-2">
          <span class="text-muted fw-bold small text-uppercase me-2">Zoom</span>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" id="zoomOutBtn" type="button"><i class="fas fa-minus"></i></button>
            <span class="btn btn-outline-secondary disabled fw-bold" id="zoomLevelDisplay" style="width: 64px;">100%</span>
            <button class="btn btn-outline-secondary" id="zoomInBtn" type="button"><i class="fas fa-plus"></i></button>
          </div>
        </div>

        <div class="vr mx-2"></div>

        <span class="hint-chip ms-auto">
          <i class="fas fa-mouse-pointer"></i> Click highlighted boxes to fill
        </span>
      </div>

      <!-- DOCUMENT FRAME -->
      <div class="doc-frame">
        <div
          class="card-body p-0 d-flex flex-column align-items-center pt-5 pb-5"
          id="document_canvas"
          style="transform-origin: top center; transition: transform 0.1s ease-out;"
        >
          <div id="placeholder_msg" class="text-center text-muted py-5 mt-5">
            <i class="fas fa-file-alt fa-3x mb-3 text-secondary opacity-50"></i>
            <h5 class="mb-1">Select a template to begin</h5>
            <div class="small">Your document will appear here and can be filled before downloading.</div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const contractTemplateUrl = "{% url 'cases:contract-template' %}";
  const selectEl = document.getElementById('html_contract_select');
  const canvas = document.getElementById('document_canvas');
  const downloadBtn = document.getElementById('download_pdf');

  // ZOOM VARIABLES
  let currentZoom = 1.0;
  const zoomStep = 0.1;
  const maxZoom = 2.0;
  const minZoom = 0.5;
  const zoomDisplay = document.getElementById('zoomLevelDisplay');

  let selectedField = null;

  // --- 1. LOAD TEMPLATE ---
  async function fetchTemplate(fileName){
    if (fileName && fileName.startsWith('db-')) {
      const id = fileName.replace('db-', '');
      try {
        const response = await fetch(`/cases/api/templates/${id}/`);
        if (!response.ok) throw new Error("Failed");
        const data = await response.json();
        return data.content;
      } catch (e) {
        return "<div class='p-5 text-danger text-center'>Error loading template.</div>";
      }
    }
    const resp = await fetch(contractTemplateUrl + '?file=' + encodeURIComponent(fileName));
    return await resp.text();
  }

  selectEl.addEventListener('change', async (e) => {
    const file = e.target.value;
    if(!file) return;

    // Loading
    canvas.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

    // Reset zoom
    currentZoom = 1.0;
    updateZoomUI();

    // Load content
    const content = await fetchTemplate(file);
    canvas.innerHTML = content;

    // Unlock all fields saved as readonly
    canvas.querySelectorAll('.pdf-input').forEach(input => {
      input.removeAttribute('readonly');
      input.style.pointerEvents = 'auto';
    });
  });

  // --- 2. ZOOM LOGIC ---
  function updateZoomUI() {
    canvas.style.transform = `scale(${currentZoom})`;
    zoomDisplay.textContent = Math.round(currentZoom * 100) + '%';
  }

  document.getElementById('zoomInBtn').addEventListener('click', () => {
    if (currentZoom < maxZoom) { currentZoom += zoomStep; updateZoomUI(); }
  });

  document.getElementById('zoomOutBtn').addEventListener('click', () => {
    if (currentZoom > minZoom) { currentZoom -= zoomStep; updateZoomUI(); }
  });

  // --- 3. MOUSE HANDLING ---
  canvas.addEventListener('mousedown', function(e) {
    const wrapper = e.target.closest('.field-wrapper');
    if (wrapper) {
      selectField(wrapper);
      const input = wrapper.querySelector('input');
      if(input) input.focus();
      return;
    }
    if (selectedField) deselectField();
  });

  // --- 4. SELECTION HELPERS ---
  function selectField(wrapper) {
    if (selectedField && selectedField !== wrapper) selectedField.classList.remove('selected');
    selectedField = wrapper;
    wrapper.classList.add('selected');
  }

  function deselectField() {
    if (selectedField) {
      selectedField.classList.remove('selected');
      selectedField = null;
    }
  }

  // --- 5. DOWNLOAD (ACCURATE PRINT) ---
  downloadBtn.addEventListener('click', () => {
    if(!canvas.querySelector('.pdf-page')) return alert("Select template first.");

    deselectField();

    // Reset zoom for accurate cloning
    const oldZoom = currentZoom;
    canvas.style.transform = 'scale(1)';
    const printContent = canvas.cloneNode(true);
    canvas.style.transform = `scale(${oldZoom})`;

    // Convert inputs to static text for print
    const wrappers = printContent.querySelectorAll('.field-wrapper');
    wrappers.forEach(w => {
      const liveWrapper = canvas.querySelectorAll('.field-wrapper')[Array.from(wrappers).indexOf(w)];
      const liveInput = liveWrapper.querySelector('input');

      const span = document.createElement('span');
      span.style.position = 'absolute';
      span.style.left = w.style.left;
      span.style.top = w.style.top;
      span.style.width = w.style.width;
      span.style.height = w.style.height;
      span.style.fontFamily = 'Courier New';
      span.style.fontWeight = 'bold';
      span.style.zIndex = '50';
      span.style.display = 'flex';
      span.style.alignItems = 'center';

      if (liveInput.type === 'checkbox') {
        span.textContent = liveInput.checked ? "X" : "";
        span.style.justifyContent = 'center';
        span.style.fontSize = '1.2em';
      } else {
        span.textContent = liveInput.value;
        span.style.fontSize = '12px';
        span.style.paddingLeft = '5px';
        span.style.whiteSpace = 'nowrap';
      }

      span.style.border = 'none';
      span.style.background = 'transparent';
      span.style.color = '#111';

      w.parentNode.replaceChild(span, w);
    });

    // Print window
    const win = window.open('', '', 'height=900,width=800');
    win.document.write('<html><head><title>Print Document</title>');
    win.document.write(`
      <style>
        @page { margin: 0; size: auto; }
        body { margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
        .pdf-page {
          position: relative;
          page-break-after: always;
          overflow: hidden;
          margin: 0 auto;
        }
        img { width: 100%; height: 100%; display: block; }
      </style>
    `);
    win.document.write('</head><body>');
    win.document.write(printContent.innerHTML);
    win.document.write('</body></html>');
    win.document.close();

    setTimeout(() => {
      win.focus();
      win.print();
      win.close();
    }, 500);
  });
</script>
{% endblock %}
