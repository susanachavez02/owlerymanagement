{% extends "base.html" %}

{% block content %}
  <a href="{% url 'cases:billing-dashboard' case_pk=invoice.case.pk %}">&larr; Back to Billing</a>
  
  <div class="card mt-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <h2 class="mb-0">Invoice #{{ invoice.pk }}</h2>
        <p class="mb-0">Case: {{ invoice.case.case_title }}</p>
      </div>
      <span class="badge 
            {% if invoice.status == 'PAID' %}bg-success
            {% elif invoice.status == 'SENT' %}bg-warning
            {% else %}bg-secondary{% endif %} fs-5">
        {{ invoice.get_status_display }}
      </span>
    </div>
    <div class="card-body">
      <p><strong>Date Issued:</strong> {{ invoice.issue_date }}</p>
      <p><strong>Date Due:</strong> {{ invoice.due_date }}</p>
      {% if request.user.roles.all|join:","|find:"Client" != -1 %}
        {% if invoice.status == 'DRAFT' or invoice.status == 'SENT' %}
          <div class="alert alert-info">
            <h5>Pay with Card</h5>
            <p>Click the button below to pay this invoice securely with Stripe.</p>
            <form action="{% url 'cases:create-checkout-session' pk=invoice.pk %}" method="POST">
              {% csrf_token %}
              <button type="submit" class="btn btn-lg btn-success">
                Pay Invoice (${{ invoice.total_amount }})
              </button>
            </form>
          </div>
        {% elif invoice.status == 'PAID' %}
          <div class="alert alert-success">
            <strong>Paid:</strong> Thank you, this invoice has been paid.
          </div>
        {% endif %}
      {% endif %}

      <h4 class="mt-4">Itemized Details</h4>
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Date</th>
            <th scope="col">Description</th>
            <th scope="col">Hours</th>
            <th scope="col">Rate</th>
            <th scope="col">Total</th>
          </tr>
        </thead>
        <tbody>
          {% for item in invoice.items.all %}
          <tr>
            <td>{{ item.time_entry.date|default:"-" }}</td>
            <td>{{ item.description }}</td>
            <td>{{ item.hours }}</td>
            <td>${{ item.rate }}</td>
            <td>${{ item.line_total }}</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="fw-bold">
            <td colspan="4" class="text-end">Total Amount Due:</td>
            <td>${{ invoice.total_amount }}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
{% endblock %}