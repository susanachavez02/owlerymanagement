{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>User Management</h2>
    {# Group buttons together on the right for better alignment #}
    <div>
      <a href="{% url 'user-create' %}" class="btn btn-primary">Create New User</a>
      <a href="{% url 'client-reassignment' %}" class="btn btn-warning">Reassign Clients</a>
      <a href="{% url 'cases:case-list' %}" class="btn btn-secondary">Back to Case List</a>
    </div>
  </div>
  <p>View all users in the system and manage their accounts.</p>

  <table class="table table-striped table-hover"> {# Added table-hover for better UX #}
    <thead class="table-light">
      <tr>
        <th scope="col">Username</th>
        <th scope="col">Full Name</th>
        <th scope="col">Email</th>
        <th scope="col">Roles</th>
        <th scope="col">Status</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>
  <strong>
    <a href="{% url 'profile-view' user_pk=user.pk %}">{{ user.username }}</a>
  </strong>
</td>
        <td>{{ user.get_full_name|default:"-" }}</td>
        <td>{{ user.email|default:"-" }}</td> {# Added default filter #}
        <td>
          {# More efficient way to display roles #}
          {{ user.roles.all|join:", " | default:"None" }}
        </td>
        <td>
          {% if user.is_active %}
            <span class="badge bg-success">Active</span>
          {% else %}
            <span class="badge bg-danger">Inactive</span>
          {% endif %}
        </td>
        <td>
          <div class="btn-group btn-group-sm" role="group" aria-label="User Actions"> {# Use btn-group-sm #}

            <a href="{% url 'user-edit' user_pk=user.pk %}" class="btn btn-primary">Edit</a>

            <form action="{% url 'user-reset-password' user_pk=user.pk %}" method="POST" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-info"
                      onclick="return confirm('Generate a new password reset link for {{ user.username }}?');">
                Reset Pass
              </button>
            </form>

            {% if user != request.user %} {# Prevent self-deactivation #}
              <form action="{% url 'user-toggle-active' user_pk=user.pk %}" method="POST" class="d-inline">
                {% csrf_token %}
                {% if user.is_active %}
                  <button type="submit" class="btn btn-danger"
                          onclick="return confirm('DEACTIVATE user {{ user.username }}?');">
                    Deactivate
                  </button>
                {% else %}
                  <button type="submit" class="btn btn-success"
                          onclick="return confirm('ACTIVATE user {{ user.username }}?');">
                    Activate
                  </button>
                {% endif %}
              </form>
            {% endif %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center text-muted fst-italic">No users found.</td> {# Added styling for empty state #}
      </tr>
      {% endfor %}
    </tbody>
  </table>

{% endblock %}