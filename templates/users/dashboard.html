{% extends "base.html" %} {# Uses the main base template with the functional navbar #}

{% block content %}

{# --- Calendar Section (For Both Attorneys and Clients) --- #}
  <section class="mb-5">
    <div class="container">
      <h3 class="mb-3">ðŸ“… Your Calendar</h3>
      <div id="calendar" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
    </div>
  </section>

  <!-- FullCalendar CSS -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

  <style>
    #calendar {
      max-width: 1000px;
      margin: 20px auto;
    }
    
    .fc {
      font-family: inherit;
    }
    
    .fc-button-primary {
      background-color: #c4a24c !important;
      border-color: #c4a24c !important;
    }
    
    .fc-button-primary:hover {
      background-color: #a68839 !important;
    }
    
    .fc-daygrid-day.fc-day-today {
      background-color: rgba(196, 162, 76, 0.1) !important;
    }
  </style>

  <!-- FullCalendar JavaScript -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: '/cases/api/calendar-events/',
        height: 'auto',
        contentHeight: 'auto',
        // NEW: Handle event clicks
        eventClick: function(info) {
          var event = info.event;
          var props = event.extendedProps;
          
          // Populate modal with event data
          document.getElementById('modalMeetingTitle').textContent = event.title;
          document.getElementById('modalCaseTitle').textContent = 'Case: ' + props.caseTitle;
          document.getElementById('modalScheduledTime').textContent = 'Scheduled: ' + props.scheduledTime;
          document.getElementById('modalMeetingType').textContent = 'Type: ' + props.meetingType;
          document.getElementById('modalDuration').textContent = 'Duration: ' + props.duration + ' minutes';
          document.getElementById('modalDescription').textContent = props.description;
          document.getElementById('modalOrganizer').textContent = 'Organized by: ' + props.organizer;
          document.getElementById('modalParticipants').textContent = 'Participants: ' + props.participants;
          
          // Show the modal
          var modal = new bootstrap.Modal(document.getElementById('meetingDetailsModal'));
          modal.show();
        }
      });
      calendar.render();
    });
  </script>

  <!-- Meeting Details Modal -->
  <div class="modal fade" id="meetingDetailsModal" tabindex="-1" aria-labelledby="meetingDetailsLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #c4a24c; color: white;">
          <h5 class="modal-title" id="meetingDetailsLabel">ðŸ“ž Meeting Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <h6 class="fw-bold" id="modalMeetingTitle">Meeting Title</h6>
          </div>
          <hr>
          <div class="mb-2">
            <strong id="modalCaseTitle">Case:</strong>
          </div>
          <div class="mb-2">
            <strong id="modalScheduledTime">Scheduled:</strong>
          </div>
          <div class="mb-2">
            <strong id="modalMeetingType">Type:</strong>
          </div>
          <div class="mb-2">
            <strong id="modalDuration">Duration:</strong>
          </div>
          <div class="mb-2">
            <strong id="modalOrganizer">Organized by:</strong>
          </div>
          <div class="mb-2">
            <strong id="modalParticipants">Participants:</strong>
          </div>
          <hr>
          <div class="mb-3">
            <h6 class="fw-bold">Description</h6>
            <p id="modalDescription" class="text-muted"></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


  {# --- Attorney Dashboard Content --- #}
  {% if is_attorney %}
  <div class="mb-4 p-3 bg-light rounded">
      <h5>Admin Quick Actions</h5>
      <div class="d-flex gap-2 flex-wrap">
        <a href="{% url 'cases:case-create' %}" class="btn btn-primary">+ Create Case</a>
        <a href="{% url 'cases:create-meeting' %}" class="btn btn-info">+ Schedule Meeting</a>
        <a href="{% url 'cases:template-list' %}" class="btn btn-secondary">Manage Templates</a>
        <a href="{% url 'cases:workflow-list' %}" class="btn btn-secondary">Manage Workflows</a>
      </div>
    </div>
    <hr>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Your Attorney Dashboard</h2>
    </div>
    <p>Welcome, Attorney. Here are your active cases.</p>
    <hr>

    <h4>Your Cases</h4>
    <div class="list-group">
      {% for case in assigned_cases %}
        <a href="{% url 'cases:case-detail' pk=case.pk %}" class="list-group-item list-group-item-action flex-column align-items-start mb-2">
          <div class="d-flex w-100 justify-content-between">
            <h5 class="mb-1">{{ case.case_title }}</h5>
            <small>Created: {{ case.date_filed|date:"Y-m-d" }}</small>
          </div>
          <p class="mb-1">{{ case.description|truncatewords:30 }}</p>
        </a>
      {% empty %}
        <div class="alert alert-info" role="alert">
          You are not assigned to any cases yet.
        </div>
      {% endfor %} {# Closes Attorney's case loop #}
    </div>

  {# --- Client Dashboard Content --- #}
  {% elif is_client %}
    <header class="py-5 bg-white border-bottom rounded-3 mb-4">
      <div class="container">
        <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3">
          <div>
            <h1 class="display-6 fw-bold mb-2">Welcome back, Client</h1>
            <p class="text-secondary mb-0">View your cases, upload documents, and manage your profile.</p>
          </div>
        </div>
      </div>
    </header>

    <section id="cases" class="py-5">
      <div class="container">
        <h2 class="h1 fw-bold mb-4">My Cases</h2>

        {# --- Display Assigned Cases --- #}
        <div class="list-group">
          {% for case in assigned_cases %} {# Start Client's case loop #}
            <a href="{% url 'cases:case-detail' pk=case.pk %}" class="list-group-item list-group-item-action flex-column align-items-start mb-2 shadow-sm border rounded-3 bg-white">
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">{{ case.case_title }}</h5>
                <div>
                  {% if case.current_stage %}
                    <span class="badge bg-info">{{ case.current_stage.name }}</span>
                  {% else %}
                    <span class="badge bg-secondary">No Stage</span>
                  {% endif %}
                  <small class="ms-2 text-muted">Filed: {{ case.date_filed|date:"Y-m-d" }}</small>
                </div>
              </div>
              <p class="mb-1 text-secondary">{{ case.description|truncatewords:30 }}</p>
              {# Show assigned attorney #}
              {% for assignment in case.assignments.all %}
                {% for role in assignment.user.roles.all %}
                  {% if role.name == 'Attorney' %}
                    <small class="text-muted">Attorney: {{ assignment.user.get_full_name|default:assignment.user.username }}</small>
                  {% endif %}
                {% endfor %} {# Closes role loop #}
              {% endfor %} {# Closes assignment loop #}
            </a>
          {% empty %} {# Correct tag for the FOR case loop #}
            <div class="alert alert-info" role="alert">
              You are not assigned to any cases yet.
            </div>
          {% endfor %} {# Closes Client's case loop #}
        </div> {# Closes list-group div #}
      </div> {# Closes container div #}
    </section>

    <section id="help" class="py-5 bg-white border-top rounded-3">
      <div class="container text-center">
        <h2 class="h4 fw-bold mb-3">Need help?</h2>
        <p class="text-secondary mb-0">Contact support or browse FAQs (coming soon).</p>
      </div>
    </section>

  {# --- Fallback --- This is OUTSIDE the client's FOR loop #}
  {% else %}
    <div class="alert alert-warning">
      Your dashboard could not be loaded. Please contact support.
    </div>
  {% endif %} {# Closes the main IF/ELIF/ELSE #}

{% endblock %}