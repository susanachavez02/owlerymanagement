{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<style>
  .chat-wrap{ max-width: 900px; }

  /* Header */
  .chat-top{
    border: 1px solid var(--border-color);
    border-radius: 16px;
    background: var(--bg-card);
    padding: 12px 14px;
  }
  .chat-back{
    width: 40px; height: 40px;
    display:flex; align-items:center; justify-content:center;
    border-radius: 999px;
    border: 1px solid var(--border-color);
    background: rgba(148,163,184,0.08);
    color: var(--text-main);
  }
  .chat-back:hover{ background: rgba(59,130,246,0.12); }

  /* Main chat card */
  .chat-card{
    border: 1px solid var(--border-color);
    border-radius: 20px;
    overflow: hidden;
    background: var(--bg-card);
  }
  .chat-history{
    background: var(--bg-card);
  }

  /* Scrollbar */
  #chat-history::-webkit-scrollbar { width: 8px; }
  #chat-history::-webkit-scrollbar-track { background: transparent; }
  #chat-history::-webkit-scrollbar-thumb { background-color: rgba(148,163,184,0.25); border-radius: 8px; }

  /* Avatars */
  .avatar-circle{
    width: 30px; height: 30px;
    border-radius: 999px;
    display:flex; align-items:center; justify-content:center;
    font-weight: 800; font-size: 12px;
    border: 1px solid var(--border-color);
    background: rgba(148,163,184,0.10);
    color: var(--text-main);
  }

  /* Bubbles */
  .bubble{
    border-radius: 14px;
    padding: 12px 14px;
    box-shadow: 0 6px 14px rgba(2,6,23,0.10);
    border: 1px solid transparent;
  }
  .bubble-me{
    background: var(--primary);
    color: #fff;
    border-bottom-right-radius: 6px !important;
  }
  .bubble-them{
    background: rgba(148,163,184,0.08);
    color: var(--text-main);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 6px !important;
  }
  .bubble-subject{
    font-size: .78rem;
    font-weight: 800;
    opacity: .85;
    padding-bottom: 6px;
    margin-bottom: 8px;
    border-bottom: 1px solid rgba(148,163,184,0.25);
  }

  /* Footer composer */
  .chat-footer{
    background: rgba(148,163,184,0.06);
    border-top: 1px solid var(--border-color);
  }
  .composer{
    background: rgba(148,163,184,0.10);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    border-radius: 999px;
    padding: 10px 16px;
    resize: none;
    box-shadow: none !important;
  }
  .composer::placeholder{ color: var(--text-muted); opacity: .9; }
  .composer:focus{
    background: rgba(148,163,184,0.10);
    border-color: rgba(59,130,246,0.55);
    outline: none;
    box-shadow: 0 0 0 .25rem rgba(59,130,246,0.18) !important;
  }

  .icon-btn{
    width: 40px; height: 40px;
    display:flex; align-items:center; justify-content:center;
    border-radius: 999px;
    border: 1px solid var(--border-color);
    background: rgba(148,163,184,0.08);
    color: var(--text-main);
  }
  .icon-btn:hover{ background: rgba(59,130,246,0.12); }

  .send-btn{
    color: var(--primary);
    font-weight: 800;
    padding: 0 10px;
    text-decoration: none;
    background: transparent;
    border: none;
  }
  .send-btn:hover{ color: #2563eb; }

  .status-dot{
    width: 8px; height: 8px;
    border-radius: 999px;
    background: #22c55e;
    display:inline-block;
  }
</style>

<div class="container chat-wrap py-3" style="height: 85vh;">
  <!-- TOP BAR -->
  <div class="chat-top d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
      <a href="{% url 'cases:case-detail' pk=case.pk %}" class="chat-back me-3" title="Back to Case">
        <i class="fas fa-arrow-left"></i>
      </a>
      <div>
        <h5 class="fw-bold mb-0" style="color: var(--text-main);">{{ case.case_title }}</h5>
        <div class="d-flex align-items-center gap-2">
          <span class="status-dot"></span>
          <small class="text-muted">Active Case Chat</small>
        </div>
      </div>
    </div>
    <button class="icon-btn" type="button" title="Info">
      <i class="fas fa-info"></i>
    </button>
  </div>

  <!-- CHAT CARD -->
  <div class="chat-card shadow-sm d-flex flex-column h-100">
    <div class="card-body p-4 flex-grow-1 overflow-auto chat-history" id="chat-history">
      {% if messages_thread %}
        {% for msg in messages_thread %}
          <div class="d-flex w-100 mb-3 {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
            {% if msg.sender != request.user %}
              <div class="me-2 align-self-end mb-1">
                <div class="avatar-circle" title="{{ msg.sender.username }}">
                  {{ msg.sender.username|make_list|first|upper }}
                </div>
              </div>
            {% endif %}

            <div class="d-flex flex-column {% if msg.sender == request.user %}align-items-end{% else %}align-items-start{% endif %}" style="max-width: 72%;">
              <div class="bubble {% if msg.sender == request.user %}bubble-me{% else %}bubble-them{% endif %}">
                {% if msg.subject and msg.subject != "Chat Message" %}
                  <div class="bubble-subject">{{ msg.subject }}</div>
                {% endif %}
                <div style="white-space: pre-wrap; font-size: 0.95rem;">{{ msg.body }}</div>
              </div>

              <small class="text-muted mt-1" style="font-size: 0.72rem; margin: 0 6px;">
                {% if msg.sender == request.user %}Sent{% endif %}
                {{ msg.sent_at|date:"g:i A" }}
              </small>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center my-auto text-muted opacity-75">
          <div class="mb-3">
            <i class="far fa-comments fa-3x"></i>
          </div>
          <h5 style="color: var(--text-main);">No messages yet</h5>
          <p class="small text-muted mb-0">Send a message to start the conversation.</p>
        </div>
      {% endif %}
    </div>

    <div class="card-footer p-3 chat-footer">
      <form method="POST" novalidate class="d-flex align-items-center gap-2 m-0">
        {% csrf_token %}
        <input type="hidden" name="subject" value="Chat Message">

        <button type="button" class="icon-btn" title="Attach Media">
          <i class="far fa-image"></i>
        </button>

        <div class="flex-grow-1">
          <textarea name="body"
                    class="form-control composer"
                    rows="1"
                    placeholder="Message..."
                    required
                    oninput="this.style.height=''; this.style.height = this.scrollHeight + 'px';"></textarea>
        </div>

        <button type="submit" class="send-btn">
          Send
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  // Auto-scroll to bottom on load
  document.addEventListener("DOMContentLoaded", function() {
    var chatHistory = document.getElementById("chat-history");
    chatHistory.scrollTop = chatHistory.scrollHeight;
  });

  // Submit on Enter (without Shift)
  const textarea = document.querySelector('textarea[name="body"]');
  if (textarea) {
    textarea.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.form.submit();
      }
    });
  }
</script>
{% endblock %}
